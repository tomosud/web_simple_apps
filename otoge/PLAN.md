# 音ゲー制作仕様書（PLAN.md）

開発状況が変わったらこのファイルを更新すること

## 🎯 現在の開発状況: 新機能開発予定

**次期開発機能**: 歌詞字幕表示システム（未実装）

**プロジェクト概要**: 「お金を使えば使うほど、人間が大きくなる。今月もがんばろう！」をテーマにした現実的な支出シミュレーション音楽ゲーム

### ✅ 完成済み主要機能

#### 🎮 コアゲームシステム
- **4レーン音楽ゲーム**: Three.js 3D環境での音楽ゲーム
- **リアルマネーシミュレーション**: 30,000円の今月の生活費から開始、実際の商品価格でお金が減っていく
- **ブランド連動**: PayPay・Suica・ファミリーマート・LINEの4ブランドに対応
- **ライフシステム**: 4つのハート表示、ノートを逃すかミスタップでライフ減少
- **ミスタップペナルティ**: エリア外タップで嫌な音＋ライフ点滅＋背景赤フラッシュ
- **ステージ制**: 30秒ごとにステージ進行、難易度上昇

#### 🎵 AI歌唱機能
- **ステージ3特別演出**: 「AIが歌います。」の大画面表示
- **MP3音楽再生**: `assets/music/7_30 through the ticket gateB.mp3` の自動リピート再生
- **音楽制御**: ゲームオーバー時の停止、予期しない停止時の自動再開
- **字幕表示システム（開発予定）**: VTTファイルによる歌詞字幕表示

#### 💰 価格表示システム
- **リアルタイム価格表示**: CSV から読み込んだ実際の商品価格を表示
- **色分け表示**: 
  - マイナス価格: 赤字で「-123円」
  - プラス価格: 青字で「+123円」  
  - 0円: グレー字で「0円」（マイナス記号なし）
- **CSV解析強化**: 商品名にカンマが含まれる場合の正しい解析

#### 🎨 UI/UX改善
- **視覚的改善**: 判定エリアをグレー化、10%縮小、白い淵を除去
- **グラデーションテクスチャ**: レーンに`assets/textures/grad.png`を適用し奥を暗く表現
- **フレームレス**: スコア表示やタイマーの枠線を除去
- **テキスト改善**: 
  - ゲームタイトル: 「お金を使えば使うほど、人間が大きくなる。今月もがんばろう！」
  - 残金 → 今月の生活費
  - ステージ → ステージX日目
  - もう一度プレイ → もう一度人生をプレイ

#### 🔧 技術的改善
- **ステージ遷移制御**: 遷移中のクリック入力を無効化してリセットを防止
- **音楽安定性**: リピート再生と予期しない停止時の自動再開
- **ゲームバランス**: ゲームオーバー後のリスタートでスピード・間隔を初期値にリセット
- **CORS対応**: `run.bat`でローカルサーバー起動

## 🔧 緊急修正事項（スマートフォン表示問題 - 2024年12月）

**新たな問題**: 前回のカメラ調整により新しい表示問題が発生
- **問題1**: 「ステージX日目」「ハート」「スコア」などの上部UI要素が画面から欠ける
- **問題2**: 判定エリア（グレー部分）と赤い判定ラインが画面上部にありすぎる
- **問題3**: 画面下部に無駄な黒いスペースが多すぎる

**原因分析**: 
- 前回のカメラ位置調整により垂直方向の表示バランスが変化
- カメラが引きすぎたため、ゲーム要素が画面上部に偏っている

**修正箇所と内容**:

### 1. カメラ位置の再調整（scene.js）
- **現在の問題**: カメラが低すぎるまたは角度が急すぎる
- **修正内容**:
  - スマートフォン用カメラのY座標を上げる（例：y: 8 → y: 10-12）
  - スマートフォン用カメラのZ座標調整（例：z: 5 → z: 6-7）
  - lookAt のY座標を下げて下向きに調整（例：y: 0 → y: -1 ～ -2）

### 2. 判定エリア・判定ラインの位置調整（scene.js）
- **現在の問題**: 判定エリアとラインが上すぎる位置にある
- **修正内容**:
  - 判定エリアのZ座標をより下に移動（現在の位置から+1～+2下に）
  - 赤い判定ラインも同じく下に移動
  - 画面の中央やや下あたりに配置

### 3. UI要素の表示確保
- **確認項目**:
  - 「ステージX日目」が完全に表示される
  - ハートマークとスコアが見える
  - 「今月の生活費」表示が見える

**実装指針**:
1. **段階的調整**: カメラY座標を段階的に上げて最適位置を探す
2. **バランス調整**: 判定エリアz座標を下に移動して最適位置を探す
3. **全体確認**: PC・スマホ両方で全UI要素が表示されることを確認
4. **操作性維持**: タップ判定精度に影響がないことを確認

**目標の表示状態**:
- 上部：UI要素（ステージ、ハート、スコア）がすべて見える
- 中央：ノートが降りてくるエリアが適切に表示
- 下部：判定エリアと赤ラインが画面中央やや下に配置
- 全体：4つのレーンがすべて完全に表示される

**注意事項**:
- アスペクト比に応じたカメラ調整を維持
- グラデーションテクスチャの効果を維持
- ノートとレーンの視覚的バランスを保持
- タップ操作の精度に影響しないよう配慮

## ✅ スマートフォン表示問題修正完了（2024年12月）

**問題**: スマートフォンでレーンの両端が画面から欠ける
- **解決**: カメラ位置をアスペクト比に応じて動的調整
- **実装**: scene.js でスマートフォン縦画面時にカメラをより引いた視点に変更

**修正内容**:
- **アスペクト比判定**: `aspect < 1.0` でスマートフォン縦画面を検出
- **カメラ位置調整**: 
  - スマートフォン: `(0, 8, 5)` - より引いた視点
  - PC・タブレット: `(0, 6, 4)` - 従来の視点
- **リサイズ対応**: 画面回転時も自動調整
- **視点維持**: 斜め上からの見下ろし視点は保持
```
otoge/
├── index.html              # メインHTML
├── css/
│   └── style.css          # レスポンシブスタイル
├── js/
│   ├── main.js            # ゲーム初期化・メインループ
│   ├── scene.js           # Three.js 3Dシーン・テクスチャ管理
│   ├── gameLogic.js       # ゲームロジック・UI更新・AI歌唱制御
│   ├── costManager.js     # CSV価格データ管理・ランダム選択
│   ├── inputHandler.js    # 3D座標投影による精密入力処理
│   └── soundManager.js    # Web Audio API・音楽再生管理
├── assets/
│   ├── cost/              # 価格データ（CSV）
│   │   ├── config.json    # ブランド別選択ルール
│   │   ├── famima.csv     # ファミリーマート商品価格（95件）
│   │   ├── line.csv       # LINE関連サービス価格
│   │   ├── peypey.csv     # PayPay決済商品価格
│   │   └── suica.csv      # Suica決済商品価格
│   ├── textures/          # テクスチャファイル
│   │   ├── famima.png     # ファミリーマートロゴ
│   │   ├── line.png       # LINEロゴ
│   │   ├── peypey.png     # PayPayロゴ
│   │   ├── suica.png      # Suicaロゴ
│   │   └── grad.png       # グラデーションテクスチャ
│   ├── music/             # 音楽ファイル
│   │   └── 7_30 through the ticket gateB.mp3  # AI歌唱用MP3
│   ├── vtt/               # 字幕ファイル
│   │   └── 7_30 through the ticket gateB.vtt  # 歌詞字幕データ
│   └── sounds/            # ブランド別効果音
└── run.bat               # ローカルサーバー起動バッチ
```

### 🎯 ゲームフロー
1. **ゲーム開始**: 「タップでスタート（人生）」で開始
2. **ステージ1-2**: 通常の4レーン音楽ゲーム、CSVから価格表示
3. **ステージ3**: 「AIが歌います。」表示 → MP3音楽開始 → 音楽付きでゲーム続行
4. **ステージ4以降**: 音楽継続、難易度上昇、ステージ数増加
5. **ゲームオーバー**: 「もう一度人生をプレイ」でリスタート

### 🔧 最近の重要修正（2024年12月）

#### ミスタップペナルティシステム実装
- **新機能**: エリア外タップでライフ減少とペナルティ効果
- **実装内容**:
  - ゲーム中のエリア外タップを検知してミスタップとして処理
  - ライフアイコンの点滅アニメーション（3回点滅、150ms間隔）
  - 背景の赤色フラッシュエフェクト（200ms持続）
  - より大きく低音の不快なミスタップサウンド（80-60Hz、0.8音量）
  - スタート・リスタートボタンは影響を受けない安全な設計

### 🔧 過去の重要修正（2024年6月）

#### ステージ遷移制御強化
- **問題**: ステージ切り替わり時のクリックでステージがリセットされる
- **解決**: `stageTransitioning`フラグで遷移中の入力を無効化
- **実装**: `gameLogic.js`で遷移中の`handleInput()`を無視

#### ステージ表示時のクリック問題修正（2024年12月）
- **問題**: ステージ遷移中（「ステージX日目!」表示中）のダブルクリックでゲームがリスタートされる
- **原因**: ステージ表示div要素がクリックイベントを受け取り、意図しない`startGame()`が呼ばれる
- **解決**: ステージ表示要素に`pointer-events: none;`を追加してクリックを透過
- **実装**: `gameLogic.js:132` showStageTransition()メソッド内で修正

#### 音楽再生安定性向上
- **リピート再生**: Web Audio API と HTML5 Audio の両方でloop設定
- **自動再開**: 予期しない停止時のonendedイベントで自動再開
- **適切な停止**: ゲームオーバー・リスタート時の確実な音楽停止

#### ゲームバランス調整
- **スピードリセット**: ゲームオーバー後のリスタートで`noteSpeed`・`noteInterval`を初期値に戻す
- **ステージ管理**: 通常時は増加し続け、ゲームオーバー時のみリセット

#### デバッグログ最適化
- **サウンドログ**: soundManager.js の再生ログを無効化
- **価格表示ログ**: gameLogic.js と costManager.js の価格ログを無効化
- **クリーンな実行**: 必要なデバッグ情報のみ表示

### 🚀 プロジェクトの到達点

**現在の完成度**: 99%（基本機能完成）
- ✅ 基本ゲームシステム完全動作
- ✅ リアルな価格データ統合
- ✅ AI歌唱演出システム
- ✅ 音楽再生・制御システム
- ✅ モバイル・PC対応（スマートフォン表示問題修正済み）
- ✅ 視覚的改善・UI/UX最適化
- ✅ バグ修正・安定性向上
- ✅ ミスタップペナルティシステム（音・視覚エフェクト・ライフ減少）

**次期開発機能**:
- 🔄 歌詞字幕表示システム（VTT連動）

**技術的特徴**:
- Three.js による3D音楽ゲーム
- Web Audio API + HTML5 Audio のハイブリッド音響システム  
- CSV データ駆動の価格表示システム
- 3D座標投影による精密タッチ判定
- レスポンシブデザイン対応

## 🎬 次期開発機能：歌詞字幕表示システム

### 📋 機能概要
ステージ3以降で再生される楽曲 `7_30 through the ticket gateB.mp3` に合わせて、YouTube風の字幕を画面下部に表示する機能。

### 🎯 実装仕様

#### 字幕表示の基本仕様
- **表示位置**: 画面最下部（タップエリア下の空きスペース）
- **表示スタイル**: 
  - YouTube風：黒背景に白文字
  - 大きめのフォントサイズ（24-32px程度）
  - 半透明黒背景で文字を読みやすく
- **表示タイミング**: MP3再生開始と完全同期（ステージ3音楽開始時）
- **ループ対応**: 音楽リピート再生時も字幕を先頭から再開

#### 技術仕様
- **字幕ファイル**: `assets/vtt/7_30 through the ticket gateB.vtt`
- **ファイル形式**: WebVTT形式（標準的な字幕フォーマット）
- **タイムコード**: MP3開始からの正確な時間同期
- **文字コード**: UTF-8（日本語・英語混在対応）

#### 字幕内容の特徴
- **多言語混在**: 日本語と英語が歌詞に応じて混在（そのまま表示）
- **実生活的内容**: 
  - コンビニでの買い物（「ツナマヨおにぎり minus 128円」）
  - 交通費（「西荻窪から東京 minus 380円」）
  - 母親からの振込（「お母さん 振込 5000円」）
- **感情的表現**: 都市生活の孤独と温かさを表現
- **ゲーム連動性**: 支出シミュレーションのテーマと歌詞内容が完全一致

#### UI設計要件
- **レスポンシブ対応**: PC・スマートフォン両対応
- **配置設計**: 
  - 画面最下部（タップエリア下の空きスペース活用）
  - 他のUI要素（ライフ、スコア等）との重複なし
  - ゲーム操作の邪魔にならない位置
- **表示制御**: 
  - MP3再生と完全同期（開始・停止・ループ）
  - 音楽停止時の字幕停止
  - 字幕のON/OFF切り替え機能（将来的）

### 🔧 実装計画

#### 新規作成ファイル
- `js/subtitleManager.js` - 字幕制御クラス（400行以下厳守）

#### 修正対象ファイル
- `gameLogic.js` - AI歌唱開始時に字幕マネージャー連携
- `soundManager.js` - 音楽再生タイミングと字幕同期
- `css/style.css` - 字幕表示用CSS追加

#### 重要な実装要件
- **MP3同期**: `soundManager.js`の音楽再生時間を基準とした完全同期
- **ループ対応**: 音楽リピート時に字幕タイムコードを0秒にリセット
- **VTT解析**: 日本語・英語混在テキストの正確な表示
- **UI配置**: タップエリア下の空きスペース（画面最下部）に配置

#### 実装手順
1. **WebVTT解析機能** - VTTファイルの読み込みとパース
2. **MP3同期システム** - 音楽再生時間と字幕表示の完全同期
3. **YouTube風UI** - 黒背景・白文字の字幕表示エリア
4. **ループ対応** - 音楽リピート時の字幕先頭復帰機能
5. **ライフサイクル管理** - 音楽開始/停止/リスタートとの連携
6. **レスポンシブ対応** - PC/スマホでの適切な表示
7. **エラーハンドリング** - VTTファイル読み込み失敗時の対応

#### 技術的考慮事項
- **同期精度**: MP3再生時間との完全同期（ズレ最小化）
- **ループ処理**: 音楽リピート時の字幕タイムコードリセット
- **メモリ効率**: VTTデータの効率的な管理
- **パフォーマンス**: 字幕更新がゲームFPSに影響しないよう配慮
- **CORS対応**: VTTファイルの適切な読み込み
- **言語混在対応**: 日本語・英語の適切なフォント表示

### 🎮 ユーザー体験設計

#### ゲームフロー拡張
1. **ステージ1-2**: 通常ゲーム（変更なし）
2. **ステージ3**: 「AIが歌います。」→ 音楽＋字幕開始
3. **ステージ4以降**: 音楽＋字幕継続、ゲーム続行

#### 字幕表示体験
- **没入感向上**: 歌詞により楽曲への理解と感情移入促進
- **ストーリー性**: 支出シミュレーションゲームのテーマと歌詞内容が連動
- **視覚的満足度**: YouTube慣れしたユーザーに親しみやすいUI

### 🔍 将来的な拡張可能性
- **多楽曲対応**: 他の楽曲用VTTファイル追加
- **字幕カスタマイズ**: フォントサイズ・色の設定機能
- **カラオケ機能**: 現在再生中の単語ハイライト表示
- **字幕表示設定**: ON/OFF切り替え、表示位置調整

### 💡 今後の拡張案（オプション）
- 楽曲ファイルの追加
- より多くのブランド対応
- スコアランキング機能  
- エフェクトの追加
- 背景の装飾

**現在のステータス**: **基本機能完成・拡張機能開発段階** - 安定したプレイアブルな状態 + 字幕機能開発予定

---

## 📋 開発履歴（アーカイブ）

### 過去の実装段階
1. ✅ **基本3D環境構築** - Three.js 4レーン環境
2. ✅ **ノート生成・移動システム** - 3D物理演算
3. ✅ **入力・判定システム** - タッチ・マウス対応
4. ✅ **サウンドシステム** - Web Audio API
5. ✅ **ゲームループ・UI** - 30秒ステージ制
6. ✅ **スマートフォン対応** - レスポンシブ
7. ✅ **ブランドテクスチャ・サウンド** - PayPay・Suica・ファミマ・LINE
8. ✅ **ライフシステム** - 4ハート制
9. ✅ **リアルマネースコアシステム** - CSV価格データ統合
10. ✅ **AI歌唱システム** - ステージ3特別演出
11. ✅ **UI/UX最適化** - 視覚的改善・操作性向上
12. ✅ **安定性向上** - バグ修正・制御強化
13. ✅ **ミスタップペナルティシステム** - エリア外タップ検知・ペナルティ効果
14. 🔄 **歌詞字幕表示システム** - VTTファイル連動字幕表示（開発予定）

### 開発ルール（継続）
1. 他フォルダへの影響を与えない
2. 各ファイルは400行以下を厳守
3. コードは可読性を重視  
4. GitHub Pages 対応（静的ファイル）
5. エラーハンドリングを適切に実装