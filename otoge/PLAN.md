# 音ゲー制作仕様書（PLAN.md）

開発状況が変わったらこのファイルを更新すること

## 追加指示（画像確認後の修正）
画像を確認し、以下の修正指示を追加：
- **ライン数**: 4ライン（現在5ラインから変更）
- **ノートサイズ**: 大きく表示して視認性向上
- **判定エリア**: 幅を広くして操作しやすく
- **カメラ視点**: 上部の空白を減らし、ゲームエリアにフォーカスした構図に調整
- **エリア視認性**: 判定エリアの境界線やラインを追加して分かりやすく
- **タッチフィードバック**: 正しくエリアをタッチした時に光るエフェクトを追加
- **UI配置**: スコアを画面上部中央に大きく、ステージ数も表示
- **操作方法**: 判定エリアへの直接タッチ/クリックのみ（キーボード操作廃止）

## ✅ 修正完了事項
**修正完了**: 判定エリアが1つしか表示されない問題
- **修正内容**: scene.js の createJudgmentAreas() 関数で境界線の位置設定を修正
- **結果**: 4つの判定エリアが正しく表示され、境界線も正常に配置

**修正完了**: ゲーム再開時に前回のノートが残る問題  
- **修正内容**: gameLogic.js に clearAllNotes() 関数を追加、startGame() で呼び出し
- **結果**: ゲーム再開時に前回のノートが完全にクリアされ、新しいゲームが正常に開始

## ✅ 追加修正完了事項
**修正完了**: 判定ライン位置の調整
- **修正内容**: 
  - 判定エリアをz=4からz=1に移動し、画面上部に配置
  - 赤い判定ラインを4つのレーン全体にわたって横断表示
  - 判定エリアの範囲を視覚的に明確化
  - ノートとの判定タイミングを適切に調整
- **結果**: 判定ラインが適切な位置に表示され、ノートとの判定が正確に動作

## ✅ 判定システム改善完了事項
**修正完了**: 判定システムの操作性向上
- **修正内容**:
  - 判定許容範囲を0.5から1.5に拡大し、より寛大な判定に変更
  - レーン外タップ時の最寄りレーン判定機能を追加
  - レーン全体でのタップを有効化
  - より直感的で操作しやすい判定システムを構築
- **結果**: ノートが判定ライン上にある時、対応するレーン上の任意の場所でタップ可能

## ✅ テクスチャ・サウンド実装完了事項
**実装完了**: ブランドテクスチャ・サウンドシステム
- **実装内容**:
  - assetsフォルダ構造作成（textures/、sounds/）
  - Three.jsテクスチャローダー実装
  - レーン別ブランドテクスチャ適用（PayPay・Suica・ファミマ・LINE）
  - ブランドサウンド連動システム
  - フォールバック機能（ファイル未配置時）
- **結果**: 各レーンに対応するブランドロゴとサウンドが適用

## ✅ スマホ対応・UI調整完了事項
**修正完了**: モバイル表示最適化
- **修正内容**:
  - レーン幅・間隔縮小（スマホ画面に収まるよう調整）
  - ノート形状変更（立方体→板状、1.1倍サイズ）
  - 3D視野角を考慮したタップ判定システム
  - ウィンドウサイズ可変対応
- **結果**: PC・スマホ両対応、正確なタップ判定を実現

## 🎨 次の段階: テクスチャ・サウンド実装
**準備完了**: 素材ファイルの用意（リサイズ済み）
- **テクスチャ素材**: 4つのブランドロゴ画像（128x128px PNG）
  1. PayPay ロゴ (`data/peipei.png`) + 決済音 (`data/paypay.wav`)
  2. Suica ロゴ (`data/suica.png`) + 決済音 (`data/suica.wav`)
  3. ファミリーマート ロゴ (`data/famima.png`) + 入店音 (`data/famima.wav`)
  4. LINE ロゴ (`data/line.png`) + 送信音 (`data/line.wav`)

**実装予定内容**:
- **ファイル移動**: `data/`から`assets/`フォルダに素材を配置
- **テクスチャマッピング**: ノートオブジェクトにブランドテクスチャを適用
- **レーン別割り当て**: 各レーンに異なるブランドテクスチャを割り当て
- **サウンド連動**: 成功時に対応するブランドサウンドを再生
- **視覚・聴覚向上**: 多様性と没入感の向上

**次のステップ**: 
1. 素材ファイルを`assets/textures/`と`assets/sounds/`に配置
2. Three.jsでテクスチャローダー実装
3. レーン別テクスチャ・サウンド適用
4. 各ブランドに対応したゲーム体験の実現

**ファイル配置計画**:
```
assets/
├── textures/
│   ├── peipei.png    # PayPay
│   ├── suica.png     # Suica
│   ├── famima.png    # ファミリーマート
│   └── line.png      # LINE
└── sounds/
    ├── paypay.wav    # PayPay決済音
    ├── suica.wav     # Suica決済音
    ├── famima.wav    # ファミマ入店音
    └── line.wav      # LINE送信音
```

## プロジェクト概要
4ラインの音楽ゲームを開発する。斜め上から見下ろすような3D視点で、上からノートが降ってきて下のタイミングエリアで正確にタップするゲームシステム。

## 技術仕様
- **3D エンジン**: Three.js を使用（ノートにテクスチャを適用するため）
- **デプロイ**: GitHub Pages対応（静的ファイルのみ）
- **対応デバイス**: スマートフォン対応必須
- **ファイル制限**: 各JavaScriptファイルは400行以下
- **開発範囲**: `/mnt/c/work/script/web_simple_apps/otoge/` フォルダ内完結

## ゲーム仕様

### 基本システム
- **視点**: 斜め上から見下ろす3D視点（上部空白を減らしゲームエリアにフォーカス）
- **ライン数**: 4つの垂直ライン（5つから変更）
- **ノート**: 上から下に一定速度で降下、大きめのサイズで視認性向上
- **判定エリア**: 各ラインの下部に配置されたタイミングエリア（幅を広く設定、境界線で明確化）
- **視覚フィードバック**: タッチ成功時の光るエフェクト
- **操作**: 判定エリアに対する直接的なタッチ/クリック入力のみ（キーボード入力は廃止）

### ゲームルール
1. ノートが判定エリアに重なったタイミングで判定エリアをタップ → 成功
2. 以下の場合は失敗：
   - ノートが判定エリアにない時に判定エリアをタップ
   - ノートが判定エリアを通過して下に消えてしまう
   - 判定エリア外をタップ

### ステージ仕様
- **ステージ時間**: 30秒
- **クリア条件**: 30秒経過
- **難易度**: ステージクリア毎にノート降下速度が上昇
- **BGM**: 一定のビートを刻むリズム音

### サウンド仕様
- **成功音**: 4つのライン毎に異なる音色
- **失敗音**: 1種類（全ライン共通）
- **BGM**: 一定のビートパターン

## 実装計画（段階別）

### 第1段階: 基本3D環境構築
- Three.js環境のセットアップ
- 斜め視点カメラの設定（上部空白を減らしゲームエリアにフォーカス）
- 4つのラインの3D配置
- 判定エリアの3D表示（幅を広く、境界線追加で視認性を向上）

### 第2段階: ノート生成・移動システム
- ノートオブジェクトの3D生成
- 上から下への移動アニメーション
- ノートの自動削除（画面外到達時）

### 第3段階: 入力・判定システム
- タッチ/クリック入力の検出（判定エリアのみ対象）
- ノートと判定エリアの当たり判定
- 成功/失敗の判定ロジック
- **タッチフィードバック**: 成功時の光るエフェクト実装

### 第4段階: サウンドシステム
- Web Audio API または HTMLAudioElement の実装
- 成功音（4種類）の生成・再生
- 失敗音（1種類）の生成・再生
- BGMの実装

### 第5段階: ゲームループ・UI
- 30秒タイマーの実装
- ステージクリア処理
- 次ステージの速度調整
- **スコア表示**: 画面上部中央に大きく表示
- **ステージ数表示**: 現在のステージを表示

### 第6段階: スマートフォン対応
- タッチイベントの最適化
- 画面サイズ対応
- パフォーマンス調整

## ファイル構成計画
```
otoge/
├── index.html          # メインHTML
├── js/
│   ├── main.js         # ゲームメインループ（<400行）
│   ├── scene.js        # Three.js シーン管理（<400行）
│   ├── gameLogic.js    # ゲームロジック（<400行）
│   ├── soundManager.js # サウンド管理（<400行）
│   └── inputHandler.js # 入力処理（<400行）
├── css/
│   └── style.css       # スタイル
└── assets/
    ├── sounds/         # サウンドファイル（将来実装）
    └── textures/       # テクスチャファイル（将来実装）
```

## 開発ルール
1. 他フォルダへの影響を与えない
2. 各ファイルは400行以下を厳守
3. コードは可読性を重視
4. Three.js の基本機能のみ使用（外部ライブラリ最小限）
5. エラーハンドリングを適切に実装

## 注意事項
- 初期段階では画像・音声ファイルは使用せず、プログラムで生成
- テクスチャ・サウンドファイルの実装は基本動作確認後
- スマートフォンでの動作テストを各段階で実施
- GitHub Pages での動作確認を定期的に実施

## 開発状況

### ✅ 第1段階: 基本3D環境構築（完了）
- ✅ Three.js で斜め視点の3Dシーンが表示される（上部空白を減らした構図）
- ✅ 4つのライン（レーン）が視覚的に確認できる
- ✅ **判定エリアが4つすべて正しく表示される（修正完了）**
- ✅ ブラウザ（PC・スマートフォン）で正常に動作する

### ✅ 第2段階: ノート生成・移動システム（完了）
- ✅ ノートオブジェクトの3D生成（大きめサイズで視認性向上）
- ✅ 上から下への移動アニメーション
- ✅ ノートの自動削除（画面外到達時）
- ✅ **ゲーム再開時のノートクリア処理（修正完了）**

### ✅ 第3段階: 入力・判定システム（完了）
- タッチ/クリック入力の検出（判定エリアのみ対象）
- ノートと判定エリアの当たり判定
- 成功/失敗の判定ロジック
- タッチフィードバック: 成功時の光るエフェクト実装

### ✅ 第4段階: サウンドシステム（完了）
- Web Audio API の実装
- 成功音（4種類）の生成・再生
- 失敗音（1種類）の生成・再生
- BGMの実装

### ✅ 第5段階: ゲームループ・UI（完了）
- 30秒タイマーの実装
- ステージクリア処理
- 次ステージの速度調整
- スコア表示: 画面上部中央に大きく表示
- ステージ数表示: 現在のステージを表示

### ✅ 第6段階: スマートフォン対応（完了）
- タッチイベントの最適化
- 画面サイズ対応
- パフォーマンス調整

## 実装済み機能
- 4ライン音楽ゲーム
- 斜め上からの3D視点（ゲームエリアにフォーカス）
- 大きなノートサイズで視認性良好
- 幅広の判定エリアと境界線表示
- 判定エリアへの直接タッチ操作
- 成功時の光るエフェクト
- Web Audio API によるサウンド生成
- 30秒ステージ制（無限ループ）
- ステージクリア後の難易度上昇
- スマートフォン対応

## 操作方法
- 判定エリアをタップ: ノートをヒット
- スペースキー: ゲーム開始（PC）

## 今後の拡張案
- 楽曲ファイルの対応
- スコアランキング機能
- 複数の楽曲選択機能
- エフェクトの追加
- 背景の装飾

## 🎮 次期実装計画: ライフシステム & ゲームフロー改善

### ライフシステム仕様
**ライフ概念の導入**:
- **初期ライフ**: 10個
- **ライフ減少条件**: ノートが判定エリアを通過して画面下に消えた場合のみ
- **ライフ減少なし**: タップミス（空振り）は許容
- **ゲームオーバー**: ライフが0になった時点
- **ライフ回復**: 次ステージ移行時に10個に全回復

### ゲームフロー改善
**ステージクリア処理**:
- **確認UI廃止**: ステージクリア時のalert()を削除
- **自動進行**: 30秒経過で自動的に次ステージへ
- **ステージ表示**: 画面中央に「Stage 2!」等を大きく表示（2-3秒間）
- **スムーズ移行**: 表示後、即座にゲーム続行

**ゲームオーバー処理**:
- **スコア表示**: 最終スコアを画面中央に表示
- **リトライUI**: 「もう一度プレイ」ボタンを配置
- **初期化**: リトライ時は全状態をリセット

### 実装計画
1. **ライフシステム実装** (gameLogic.js)
2. **UI更新** (HTML/CSS - ライフ表示追加)
3. **ゲームフロー改善** (ステージ移行・ゲームオーバー)
4. **リトライシステム** (main.js)

## 💰 次期実装計画: リアルマネースコアシステム

### ゲームコンセプト変更
**新しいテーマ**: 日常の決済体験をゲーム化
- **設定**: PayPay・Suica・ファミマ・LINEでお金を使う日常を表現
- **スコア概念**: 「お金を節約する」ゲーム（支出を抑える）
- **勝利条件**: マイナス（支出）が少ないほど良いスコア

### スコアシステム仕様
**スコア管理**:
- **初期値**: 30,000円からスタート
- **表示単位**: 円（UI表示に「円」を付加）
- **計算方式**: 30,000円から支出を引いていく
- **目標**: 残金をできるだけ多く残す

**支出データベース**:
- **CSVファイル**: 各ブランドの実際の商品・サービス価格
- **ファイル構成**:
  - `famima.csv`: ファミマ商品（コンビニ商品）
  - `line.csv`: LINE関連サービス（スタンプ等）
  - `peypey.csv`: PayPay決済商品
  - `suica.csv`: 交通費・駅構内商品

### ランダム選択ルール
**選択設定** (`otoge/assets/cost/config.json`):
```json
{
  "famima": { "min": 2, "max": 5 },
  "line": { "min": 1, "max": 1 },
  "peypey": { "min": 1, "max": 1 },
  "suica": { "min": 1, "max": 1 }
}
```

### 支出表示システム
**アニメーション表示**:
- **表示位置**: スコアの下に一時表示
- **表示内容**: 商品名 + 価格（絶対値）
- **表示例**: 「生コッペパン（ハムカツ＆たまご） 180円」
- **アニメーション**: 
  - 出現: フェードイン + スライドアップ
  - 表示: 2-3秒間表示
  - 消失: フェードアウト

### 実装計画（段階別）
1. **CSVファイル構造確認・作成**
2. **設定JSON作成** (`config.json`)
3. **CSVローダー実装** (`costManager.js`)
4. **スコアシステム変更** (gameLogic.js)
5. **支出表示UI実装** (HTML/CSS)
6. **アニメーション実装**

**現在のステータス: ライフシステム完成 → リアルマネースコアシステム実装段階**