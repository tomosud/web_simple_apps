# 音ゲー制作仕様書（PLAN.md）

開発状況が変わったらこのファイルを更新すること

## 🎯 現在の開発状況: ほぼ完成状態

**プロジェクト概要**: 「お金を使えば使うほど、人間が大きくなる。今月もがんばろう！」をテーマにした現実的な支出シミュレーション音楽ゲーム

### ✅ 完成済み主要機能

#### 🎮 コアゲームシステム
- **4レーン音楽ゲーム**: Three.js 3D環境での音楽ゲーム
- **リアルマネーシミュレーション**: 30,000円の今月の生活費から開始、実際の商品価格でお金が減っていく
- **ブランド連動**: PayPay・Suica・ファミリーマート・LINEの4ブランドに対応
- **ライフシステム**: 4つのハート表示、ノートを逃すとライフ減少
- **ステージ制**: 30秒ごとにステージ進行、難易度上昇

#### 🎵 AI歌唱機能
- **ステージ3特別演出**: 「AIが歌います。」の大画面表示
- **MP3音楽再生**: `assets/music/7_30 through the ticket gateB.mp3` の自動リピート再生
- **音楽制御**: ゲームオーバー時の停止、予期しない停止時の自動再開

#### 💰 価格表示システム
- **リアルタイム価格表示**: CSV から読み込んだ実際の商品価格を表示
- **色分け表示**: 
  - マイナス価格: 赤字で「-123円」
  - プラス価格: 青字で「+123円」  
  - 0円: グレー字で「0円」（マイナス記号なし）
- **CSV解析強化**: 商品名にカンマが含まれる場合の正しい解析

#### 🎨 UI/UX改善
- **視覚的改善**: 判定エリアをグレー化、10%縮小、白い淵を除去
- **グラデーションテクスチャ**: レーンに`assets/textures/grad.png`を適用し奥を暗く表現
- **フレームレス**: スコア表示やタイマーの枠線を除去
- **テキスト改善**: 
  - ゲームタイトル: 「お金を使えば使うほど、人間が大きくなる。今月もがんばろう！」
  - 残金 → 今月の生活費
  - ステージ → ステージX日目
  - もう一度プレイ → もう一度人生をプレイ

#### 🔧 技術的改善
- **ステージ遷移制御**: 遷移中のクリック入力を無効化してリセットを防止
- **音楽安定性**: リピート再生と予期しない停止時の自動再開
- **ゲームバランス**: ゲームオーバー後のリスタートでスピード・間隔を初期値にリセット
- **CORS対応**: `run.bat`でローカルサーバー起動

## 🔧 緊急修正事項（スマートフォン表示問題 - 2024年12月）

**新たな問題**: 前回のカメラ調整により新しい表示問題が発生
- **問題1**: 「ステージX日目」「ハート」「スコア」などの上部UI要素が画面から欠ける
- **問題2**: 判定エリア（グレー部分）と赤い判定ラインが画面上部にありすぎる
- **問題3**: 画面下部に無駄な黒いスペースが多すぎる

**原因分析**: 
- 前回のカメラ位置調整により垂直方向の表示バランスが変化
- カメラが引きすぎたため、ゲーム要素が画面上部に偏っている

**修正箇所と内容**:

### 1. カメラ位置の再調整（scene.js）
- **現在の問題**: カメラが低すぎるまたは角度が急すぎる
- **修正内容**:
  - スマートフォン用カメラのY座標を上げる（例：y: 8 → y: 10-12）
  - スマートフォン用カメラのZ座標調整（例：z: 5 → z: 6-7）
  - lookAt のY座標を下げて下向きに調整（例：y: 0 → y: -1 ～ -2）

### 2. 判定エリア・判定ラインの位置調整（scene.js）
- **現在の問題**: 判定エリアとラインが上すぎる位置にある
- **修正内容**:
  - 判定エリアのZ座標をより下に移動（現在の位置から+1～+2下に）
  - 赤い判定ラインも同じく下に移動
  - 画面の中央やや下あたりに配置

### 3. UI要素の表示確保
- **確認項目**:
  - 「ステージX日目」が完全に表示される
  - ハートマークとスコアが見える
  - 「今月の生活費」表示が見える

**実装指針**:
1. **段階的調整**: カメラY座標を段階的に上げて最適位置を探す
2. **バランス調整**: 判定エリアz座標を下に移動して最適位置を探す
3. **全体確認**: PC・スマホ両方で全UI要素が表示されることを確認
4. **操作性維持**: タップ判定精度に影響がないことを確認

**目標の表示状態**:
- 上部：UI要素（ステージ、ハート、スコア）がすべて見える
- 中央：ノートが降りてくるエリアが適切に表示
- 下部：判定エリアと赤ラインが画面中央やや下に配置
- 全体：4つのレーンがすべて完全に表示される

**注意事項**:
- アスペクト比に応じたカメラ調整を維持
- グラデーションテクスチャの効果を維持
- ノートとレーンの視覚的バランスを保持
- タップ操作の精度に影響しないよう配慮

## ✅ スマートフォン表示問題修正完了（2024年12月）

**問題**: スマートフォンでレーンの両端が画面から欠ける
- **解決**: カメラ位置をアスペクト比に応じて動的調整
- **実装**: scene.js でスマートフォン縦画面時にカメラをより引いた視点に変更

**修正内容**:
- **アスペクト比判定**: `aspect < 1.0` でスマートフォン縦画面を検出
- **カメラ位置調整**: 
  - スマートフォン: `(0, 8, 5)` - より引いた視点
  - PC・タブレット: `(0, 6, 4)` - 従来の視点
- **リサイズ対応**: 画面回転時も自動調整
- **視点維持**: 斜め上からの見下ろし視点は保持
```
otoge/
├── index.html              # メインHTML
├── css/
│   └── style.css          # レスポンシブスタイル
├── js/
│   ├── main.js            # ゲーム初期化・メインループ
│   ├── scene.js           # Three.js 3Dシーン・テクスチャ管理
│   ├── gameLogic.js       # ゲームロジック・UI更新・AI歌唱制御
│   ├── costManager.js     # CSV価格データ管理・ランダム選択
│   ├── inputHandler.js    # 3D座標投影による精密入力処理
│   └── soundManager.js    # Web Audio API・音楽再生管理
├── assets/
│   ├── cost/              # 価格データ（CSV）
│   │   ├── config.json    # ブランド別選択ルール
│   │   ├── famima.csv     # ファミリーマート商品価格（95件）
│   │   ├── line.csv       # LINE関連サービス価格
│   │   ├── peypey.csv     # PayPay決済商品価格
│   │   └── suica.csv      # Suica決済商品価格
│   ├── textures/          # テクスチャファイル
│   │   ├── famima.png     # ファミリーマートロゴ
│   │   ├── line.png       # LINEロゴ
│   │   ├── peypey.png     # PayPayロゴ
│   │   ├── suica.png      # Suicaロゴ
│   │   └── grad.png       # グラデーションテクスチャ
│   ├── music/             # 音楽ファイル
│   │   └── 7_30 through the ticket gateB.mp3  # AI歌唱用MP3
│   └── sounds/            # ブランド別効果音
└── run.bat               # ローカルサーバー起動バッチ
```

### 🎯 ゲームフロー
1. **ゲーム開始**: 「タップでスタート（人生）」で開始
2. **ステージ1-2**: 通常の4レーン音楽ゲーム、CSVから価格表示
3. **ステージ3**: 「AIが歌います。」表示 → MP3音楽開始 → 音楽付きでゲーム続行
4. **ステージ4以降**: 音楽継続、難易度上昇、ステージ数増加
5. **ゲームオーバー**: 「もう一度人生をプレイ」でリスタート

### 🔧 最近の重要修正（2024年6月）

#### ステージ遷移制御強化
- **問題**: ステージ切り替わり時のクリックでステージがリセットされる
- **解決**: `stageTransitioning`フラグで遷移中の入力を無効化
- **実装**: `gameLogic.js`で遷移中の`handleInput()`を無視

#### ステージ表示時のクリック問題修正（2024年12月）
- **問題**: ステージ遷移中（「ステージX日目!」表示中）のダブルクリックでゲームがリスタートされる
- **原因**: ステージ表示div要素がクリックイベントを受け取り、意図しない`startGame()`が呼ばれる
- **解決**: ステージ表示要素に`pointer-events: none;`を追加してクリックを透過
- **実装**: `gameLogic.js:132` showStageTransition()メソッド内で修正

#### 音楽再生安定性向上
- **リピート再生**: Web Audio API と HTML5 Audio の両方でloop設定
- **自動再開**: 予期しない停止時のonendedイベントで自動再開
- **適切な停止**: ゲームオーバー・リスタート時の確実な音楽停止

#### ゲームバランス調整
- **スピードリセット**: ゲームオーバー後のリスタートで`noteSpeed`・`noteInterval`を初期値に戻す
- **ステージ管理**: 通常時は増加し続け、ゲームオーバー時のみリセット

#### デバッグログ最適化
- **サウンドログ**: soundManager.js の再生ログを無効化
- **価格表示ログ**: gameLogic.js と costManager.js の価格ログを無効化
- **クリーンな実行**: 必要なデバッグ情報のみ表示

### 🚀 プロジェクトの到達点

**完成度**: 99%以上
- ✅ 基本ゲームシステム完全動作
- ✅ リアルな価格データ統合
- ✅ AI歌唱演出システム
- ✅ 音楽再生・制御システム
- ✅ モバイル・PC対応（スマートフォン表示問題修正済み）
- ✅ 視覚的改善・UI/UX最適化
- ✅ バグ修正・安定性向上

**技術的特徴**:
- Three.js による3D音楽ゲーム
- Web Audio API + HTML5 Audio のハイブリッド音響システム  
- CSV データ駆動の価格表示システム
- 3D座標投影による精密タッチ判定
- レスポンシブデザイン対応

### 💡 今後の拡張案（オプション）
- 楽曲ファイルの追加
- より多くのブランド対応
- スコアランキング機能  
- エフェクトの追加
- 背景の装飾

**現在のステータス**: **ほぼ完成** - 安定したプレイアブルな状態

---

## 📋 開発履歴（アーカイブ）

### 過去の実装段階
1. ✅ **基本3D環境構築** - Three.js 4レーン環境
2. ✅ **ノート生成・移動システム** - 3D物理演算
3. ✅ **入力・判定システム** - タッチ・マウス対応
4. ✅ **サウンドシステム** - Web Audio API
5. ✅ **ゲームループ・UI** - 30秒ステージ制
6. ✅ **スマートフォン対応** - レスポンシブ
7. ✅ **ブランドテクスチャ・サウンド** - PayPay・Suica・ファミマ・LINE
8. ✅ **ライフシステム** - 4ハート制
9. ✅ **リアルマネースコアシステム** - CSV価格データ統合
10. ✅ **AI歌唱システム** - ステージ3特別演出
11. ✅ **UI/UX最適化** - 視覚的改善・操作性向上
12. ✅ **安定性向上** - バグ修正・制御強化

### 開発ルール（継続）
1. 他フォルダへの影響を与えない
2. 各ファイルは400行以下を厳守
3. コードは可読性を重視  
4. GitHub Pages 対応（静的ファイル）
5. エラーハンドリングを適切に実装