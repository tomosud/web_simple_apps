# 目の開閉検出ゲーム

## 概要
スマホのカメラを使用して顔を認識し、目の開閉状態をリアルタイムで検出するWebアプリケーション。特定の時間だけ目をつぶって、ちょうどの時間で開くゲームを最終目標とする。

## 技術仕様

### 使用技術
- **顔検出**: TensorFlow.js + MediaPipe Face Mesh
- **目の開閉判定**: EAR (Eye Aspect Ratio) 手法
- **まばたき検出**: 正確なEAR計算による瞬き回数カウント
- **フロントエンド**: HTML5, CSS3, Vanilla JavaScript
- **カメラアクセス**: WebRTC (getUserMedia API)

### 技術選定の根拠

#### MediaPipe Face Landmarker vs WebGazer.js 比較

| 項目 | MediaPipe Face Landmarker | WebGazer.js |
|------|---------------------------|-------------|
| **目的** | 顔認識・ランドマーク検出 | 視線追跡 |
| **精度** | 高精度（468個の3Dランドマーク） | 中程度（回帰モデルベース） |
| **モバイル最適化** | ✅ BlazeFaceベースで最適化 | ❌ モバイルで重い |
| **キャリブレーション** | ✅ 不要 | ❌ 必要 |
| **目の開閉検出** | ✅ EARで高精度検出 | ❌ 主目的でない |
| **リアルタイム性** | ✅ 30fps以上安定 | ❌ ノイズが多い |
| **ファイルサイズ** | 約10MB | 軽量 |

**結論**: 目の開閉検出の精度を重視する本プロジェクトには、MediaPipe Face Landmarkerが最適。

### MediaPipe導入方法

#### 推奨ライブラリ
- **MediaPipe Tasks Vision**: `@mediapipe/tasks-vision@latest`
- **CDN**: `https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/vision_bundle.js`

#### 重要なポイント
- **Face Landmarker**: 468個の3D顔ランドマークを提供
- **EAR (Eye Aspect Ratio)**: 目の開閉度を数値で判定する手法
- **GPU最適化**: モバイルデバイスでの性能向上
- **リアルタイム処理**: VIDEO modeでの連続検出

### 対応デバイス
- iPhone (Safari 14+)
- Android (Chrome 90+)
- デスクトップブラウザ (Chrome, Firefox, Safari)

## 機能仕様

### Phase 1: 技術検証 ✅ 完了
1. **カメラ表示**: リアルタイムカメラ映像の表示
2. **顔認識表示**: 
   - 顔が検出されている場合: Face Meshを重ね表示
   - 顔が検出されていない場合: "顔を認識できていない" メッセージ
3. **目の開閉検出**:
   - 目が開いている: 青い文字で "目を開いている" 表示
   - 目をつぶっている: 赤い文字で "目を閉じている" 表示
4. **まばたき検出システム**: ✅ **実装完了**
   - 正確なEAR計算: `EAR = (|p2−p6| + |p3−p5|) / (2 × |p1−p4|)`
   - 指定ランドマーク使用（左目: [33,160,158,133,153,144], 右目: [362,385,387,263,373,380]）
   - EAR閾値0.27未満でまばたき検出
   - リアルタイムまばたき回数カウント
   - まばたき履歴表示（タイムスタンプ付き）
5. **履歴表示**: 
   - 0.5秒間隔で状態更新
   - 映画のクレジット風に上に流れるアニメーション
   - まばたき検出イベントも履歴に記録

### Phase 2: ゲーム機能 (将来)
1. **タイマーゲーム**: 指定時間だけ目をつぶるチャレンジ
2. **首振り操作**: 縦横の首振りでYES/NO判定
3. **スコア機能**: 精度とタイミングの評価

## 動作要件
- HTTPS環境での実行 (カメラアクセスのため)
- 十分な照明条件
- 顔がカメラに正面向きで映ること

## 起動方法
```bash
# 開発サーバー起動
./run.bat

# ブラウザで以下にアクセス
http://localhost:8008
```

## 実装状況

### ✅ 完成済み機能
- **基本顔検出**: TensorFlow.js + MediaPipe Face Meshによる安定した顔認識
- **目の開閉判定**: リアルタイムEAR計算による目の状態検出
- **まばたき検出**: 正確なEAR公式による瞬きカウント機能
- **UI/UX**: レスポンシブデザイン、リアルタイム状態表示
- **履歴機能**: 検出イベントの時系列記録

### 🧪 利用可能なページ
1. **`index.html`** - メインアプリケーション（統合UI）
2. **`blink_detection.html`** - まばたき検出専用テストページ
3. **`tensorflow_test.html`** - TensorFlow.js動作確認ページ

### 📊 検証結果
- **まばたき検出精度**: ✅ 動作確認済み
- **EAR計算**: ✅ 指定公式で正確に実装
- **リアルタイム性**: ✅ 30fps安定動作
- **モバイル対応**: ✅ レスポンシブデザイン実装

## ファイル構成
```
eye_close/
├── index.html               # メインアプリケーション
├── blink_detection.html     # まばたき検出専用ページ
├── tensorflow_test.html     # TensorFlow.js動作テスト
├── js/
│   ├── camera.js           # カメラ制御
│   ├── faceDetector.js     # 顔・目・まばたき検出ロジック
│   └── gameUI.js           # UI制御とアニメーション
├── css/
│   └── style.css           # スタイルシート
├── samplecode/             # 参考サンプルコード
├── run.bat                 # 開発用サーバー起動スクリプト
├── README.md               # 本ファイル
└── PLAN.md                # 実装計画
```

## 次のステップ（Phase 2準備）
1. **ゲーム機能**: タイマーチャレンジの実装
2. **精度向上**: 個人別EAR閾値キャリブレーション
3. **統計機能**: まばたき頻度分析
4. **PWA対応**: オフライン動作とホーム画面追加
