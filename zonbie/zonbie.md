# Underfloor Guardians 仕様書
**プロジェクト名：** Underfloor Guardians
**バージョン：** 4.0 — タップ押し出しシステム・最適化版
**作成日：** 2025-05-31
**更新日：** 2025-06-01

## 実行環境
```
C:\work\script\web_simple_apps\zonbie
```
このフォルダ以下のファイルを使用。GitHub Pagesで公開し、スマホでの実行を想定。

**エントリーポイント：** `C:\work\script\web_simple_apps\zonbie\zonbie.html`

---

## 1. ゲーム概要

### 基本コンセプト
床下から見上げる視点での3D脱出ゲーム。プレイヤーは床下の守護者として、多数のゾンビを避けながら人を安全に出口まで導く。賢いAIが計算した曲線経路と戦略的なゾンビ妨害がカギとなる。

| 項目 | 内容 |
| --- | --- |
| **ジャンル** | 3D脱出アクション / 戦略ゲーム |
| **視点** | 床下視点（Y軸を反転した特殊カメラ・操作対応） |
| **操作** | マウスクリック/タップでゾンビ妨害 + カメラ操作 |
| **難易度** | 高難易度（即死判定） |
| **自動開始** | 1秒後の自動ゲーム開始機能 |

---

## 2. 部屋システム

### 2.1 部屋生成
- **9:16比率統一**: 横36×縦64単位の縦長フィールド
- **画面対応**: PC・スマホ問わず縦画面レイアウトで統一
- **画面最大化**: ウィンドウサイズの縦にフィールドをフィット
- **ランダム生成**: 毎ステージ異なる部屋レイアウト
- **入口**: 4つの壁（北・南・東・西）からランダム選択
- **出口**: 入口以外の壁から1-2個をランダム配置
- **距離制限**: 入口と出口の最小距離15単位を確保

### 2.2 部屋間連続性
- **位置継承**: 前ステージの出口位置→次ステージの対向壁の同位置が入口
- **隣の部屋感**: 実際に隣の部屋に移動している感覚を演出

### 2.3 視覚表示
- **入口エリア**: 青い円形エリア（半径3単位）
- **出口エリア**: 緑の円形エリア（半径3単位）
- **床面表示**: 0.2の高さで確実に視認可能

---

## 3. 高度パスファインディングシステム

### 3.1 改良版曲線経路計算
```
スタート → 中間点1 → ... → 中間点N → ゴール
```
- **動的ウェイポイント**: 距離に応じて5-10点の可変構成
- **円形候補配置**: より滑らかな回避のための円形候補点システム
- **予測危険度**: ゾンビの移動方向を考慮した未来位置計算
- **段階的ペナルティ**: 危険度に応じた細分化された回避判定
- **経路の滑らかさ**: 角度変化を考慮した自然な曲線生成
- **積極的ゴール指向**:
  - ゴール直前（8単位以内）: 危険度を軽減して積極移動
  - ゴール近く（15単位以内）: 中程度のリスクを許容
- **境界チェック**: フィールド外への移動を防止

### 3.2 動的経路更新（最適化済み）
- **更新頻度**: 1.5秒ごとに再計算（処理負荷軽減）
- **目標変更**: 複数出口時は最短距離を自動選択
- **回避行動**: ゾンビ配置変化に応じた経路調整

### 3.3 移動システム
- **ウェイポイント追従**: 各中間点を順番に辿る
- **到達判定**: 1単位以内で次のポイントへ移行
- **自然な動き**: 滑らかな曲線移動を実現

---

## 4. ゾンビAIシステム

### 4.1 基本仕様
- **数量**: 10匹固定（高難易度設定）
- **検知範囲**: 20単位（遠距離検知）
- **即死判定**: 1単位以内の接触で即座にゲームオーバー

### 4.2 4段階行動パターン
| 状態 | 行動 | 特徴 |
| --- | --- | --- |
| **徘徊（wandering）** | ランダム移動 | 2秒ごとに方向変更、50%速度 |
| **回転（rotating）** | 目標方向に回転 | プレイヤー発見時の方向転換 |
| **追跡（chasing）** | 直接追跡 | 最短距離でプレイヤーを追跡 |
| **転倒（down）** | 一時停止 | タップ押し出し後の2秒間停止状態 |

### 4.3 AI挙動詳細
- **探索行動**: 人がいない場合の継続的なランダム移動
- **回転行動**: 最短角度での効率的な方向転換
- **追跡行動**: リアルタイムでの最短距離追跡
- **状態復帰**: 転倒後のランダム方向設定

---

## 5. プレイヤー操作システム

### 5.1 基本操作
- **自動移動**: AIが計算した最適経路での自動移動
- **妨害操作**: シングルタッチ/左クリックでゾンビを転倒（同時2個まで）
- **カメラ操作**: マウス中クリック・ホイール / スマホピンチ・二本指ドラッグ
- **戦略要素**: タイミングを見計らった妨害が重要

### 5.2 押し出しシステム
- **操作方法**: シングルタッチまたは左クリック
- **同時効果**: 最大2箇所まで同時処理
- **押し出し方向**: タップ位置からゾンビへのベクトル方向
- **強度システム**:
  - 内側範囲（半径1.5単位）: 最大強度3.0単位
  - 外側範囲（半径7.5単位）: 3.0→0.0へリニア減衰
  - 範囲外: 効果なし
- **転倒効果**: 押し出し後2秒間の転倒状態
- **復帰行動**: ランダム方向からスタート→人発見で追跡
- **視覚効果**:
  - 内側濃い輪（最大強度範囲）
  - 外側薄い輪（影響範囲境界）
  - 45度傾斜表示

### 5.3 カメラ操作システム
#### PC操作
- **ドラッグ**: マウス中クリック + ドラッグでカメラ移動
- **ズーム**: マウスホイールでズームイン/アウト
- **ゲーム操作**: 左クリックでゾンビ妨害

#### スマホ操作（左右修正済み）
- **ピンチズーム**: 二本指でのピンチジェスチャー
- **カメラ移動**: 二本指ドラッグでカメラ位置調整（自然な左右操作）
- **ゲーム操作**: シングルタッチでゾンビ押し出し

#### カメラ仕様
- **ズーム範囲**: Y座標-20〜-80（部屋全体〜詳細表示）
- **移動範囲**: フィールドの30%以内に制限
- **初期位置**: Y座標-45（部屋全体が見える位置）

---

## 6. デバッグ・可視化システム

### 6.1 パス表示機能
- **曲線経路**: 明るい緑色の太いボックスで経路全体を表示
- **ウェイポイント**: 色分けされた大型円柱マーカー
  - 青: スタート地点
  - 黄: 中間ウェイポイント
  - 赤: ゴール地点
- **危険ゾーン**: ゾンビ周辺の赤い円柱（半径8単位）

### 6.2 方向表示
- **人の方向**: 青いライン（3単位長）
- **現在ターゲット**: 緑いライン（次のウェイポイントへ）
- **ゾンビの方向**: 状態別色分けライン
  - 徘徊: 薄い赤
  - 回転: オレンジ
  - 追跡: ピンク

### 6.3 詳細ログ
- **パス情報**: 全ウェイポイントの座標出力
- **移動状況**: ウェイポイント到達をリアルタイム表示
- **状態変化**: AI状態遷移の詳細ログ

---

## 7. エンティティ仕様

| エンティティ | 表示 | 速度 | 特徴 |
| --- | --- | --- | --- |
| **人** | 青い球体 | 1.5 | 曲線経路での自動移動 |
| **ゾンビ** | 赤い球体 | 1.0 | 3段階AI行動パターン |
| **入口** | 青い円形エリア | - | スタート位置 |
| **出口** | 緑の円形エリア | - | ゴール位置 |

---

## 8. ゲームフロー

### 8.1 ステージ進行
1. 部屋生成（入口・出口配置）
2. プレイヤー配置（入口エリア）
3. ゾンビ配置（10匹ランダム）
4. 経路計算・表示
5. ゲーム開始

### 8.2 勝敗条件
- **勝利**: 出口エリア到達で次ステージへ
- **敗北**: ゾンビとの接触で即座にゲームオーバー
- **継続**: 無限ステージでエンドレスプレイ

---

## 9. UI・HUD

### 9.1 ゲーム情報
- **ステージ数**: 現在のステージ番号を表示
- **経過時間**: ステージ開始からの時間

### 9.2 デバッグ情報（モバイル向けに無効化）
- **エンティティ座標**: 人・ゾンビの詳細位置（コンソールログのみ）
- **AI状態**: 各ゾンビの現在状態（コンソールログのみ）
- **出口数**: 現在ステージの出口数（コンソールログのみ）
- **視覚デバッグ**: 危険ゾーン表示を無効化（パフォーマンス向上）

---

## 10. 技術仕様

### 10.1 使用技術
- **3D描画**: Three.js r128
- **パフォーマンス**: 60fps安定動作（モバイル最適化済み）
- **処理負荷軽減**:
  - デバッグログ3秒ごと（67%削減）
  - 経路更新1.5秒ごと（33%削減）
  - 危険ゾーン更新を経路更新時のみに限定
- **レスポンシブ**: 9:16比率統一、縦画面レイアウト
- **床下視点**: カメラY座標-30、Z軸上方向設定

### 10.2 画面仕様
- **統一レイアウト**: PC・スマホ問わず9:16比率の縦長表示
- **フィールドサイズ**: FIELD_SIZE_X=36, FIELD_SIZE_Z=64
- **画面フィット**: ウィンドウサイズの縦にフィールドをフィット
- **画面最大化**: 100vw×100vh で画面いっぱいに表示

### 10.3 アルゴリズム
- **パスファインディング**: 危険度計算による最適経路選択（48候補点評価）
- **ゴール優先ロジック**: ゴール8単位以内では直線移動を大幅優遇
- **危険度軽減**: ゴール接近時は危険度を70%軽減
- **AI状態機械**: 有限状態オートマトンによるゾンビ行動
- **衝突判定**: リアルタイム距離計算
- **エンティティシステム**: 統一エンティティ管理と後方互換性

### 10.4 床下視点システム
- **初期カメラ設定**: `camera.position.set(0, -45, 0)`
- **上方向**: `camera.up.set(0, 0, 1)` (Z軸を上に設定)
- **視点効果**: 床下から見上げる独特の視覚体験
- **視野調整**: 縦長フィールド全体と壁の全体が見えるように距離を調整
- **操作対応**: ズーム・ドラッグによる動的な視点変更

### 10.5 カメラ操作システム
- **ズーム制御**: Y座標-20〜-80の範囲で動的調整
- **ドラッグ制御**: X・Z軸でのカメラ位置移動（フィールド30%制限）
- **マウス対応**: 中クリックドラッグ・ホイールズーム
- **タッチ対応**: ピンチズーム・二本指ドラッグ
- **操作分離**: カメラ操作とゲーム操作の完全分離

### 10.6 視覚仕様
- **壁の色**: 明るいグレー（0xaaaaaa）で視認性向上
- **壁の透明度**: 0.8で適度な存在感を確保
- **床グリッド**: 0.6透明度で背景として機能

---

## 11. 開発者向け機能

### 11.1 デバッグ支援（モバイル最適化）
- **コンソールログ**: 詳細な座標・状態情報
- **視覚デバッグ**: 経路表示のみ（危険ゾーン表示は無効化）
- **リアルタイム監視**: AI挙動の逐次確認（コンソールベース）
- **自動起動**: 開発効率向上のための自動ゲーム開始

### 11.2 調整可能パラメータ
- **速度**: 人・ゾンビの移動速度
- **範囲**: 検知・回避・タップ範囲
- **時間**: 転倒時間・更新間隔

## 12. エンティティ統一システム

### 12.1 統一エンティティ構造
```javascript
{
    id: number,              // 一意ID
    type: 'human' | 'zombie', // エンティティタイプ
    state: string,           // 現在の状態
    position: {x, z},        // 統一座標
    movement: {              // 移動情報
        speed, direction, path, pathIndex
    },
    ai: {                    // AI情報
        target, detectionRange, behavior
    },
    timers: {                // タイマー情報
        stateTimer, pathUpdateTimer, contactTimer, etc.
    }
}
```

### 12.2 後方互換性
- 既存の`humans`、`zombies`配列との完全互換性
- 個別プロパティ（`x`, `z`, `speed`等）の自動同期
- レガシーコードの完全動作保証

## 13. タップ押し出しシステム

### 13.1 押し出し力計算
```javascript
内側範囲（0 ～ TAP_RADIUS × 0.5）: 一定の最大強度3.0
減衰範囲（TAP_RADIUS × 0.5 ～ TAP_RADIUS × 2.5）: 3.0から0.0へリニア減衰
範囲外: 効果なし
```

### 13.2 視覚化システム
- **内側の濃い輪**: 最大強度範囲（TAP_RADIUS × 0.5）
- **外側の薄い輪**: 影響範囲境界（TAP_RADIUS × 2.5）
- **リニア補間**: 輪の間で強度が滑らかに変化

### 13.3 方向計算
- **ベクトル**: タップ位置からゾンビへの方向
- **正規化**: 単位ベクトル × 押し出し力
- **境界チェック**: フィールド外への移動を防止

---

*本仕様書は実装に合わせて随時更新される。*