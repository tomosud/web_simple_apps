# 親敵・子敵システム詳細仕様書

## 概要
Ball Attackゲームに親敵・子敵システムを導入し、より戦略的で複雑なゲームプレイを実現する。

## ゲームサイクル

### ステージ制システム
親敵をすべて倒すと子敵も壊滅してステージクリアとなるステージ制ゲーム。

#### ステージ構成
| ステージ | 初期子敵数 | 親敵数 | 備考 |
|---------|-----------|--------|------|
| ステージ1 | 0個 | 1個 | 親敵が子敵を配置 |
| ステージ2 | 0個 | 2個 | 親敵が子敵を配置 |
| ステージ3 | 0個 | 3個 | 親敵が子敵を配置 |

### クリア条件
- **ステージクリア**: 全ての親敵を撃破
- **子敵壊滅**: 親敵が全滅すると子敵も自動的に壊滅

## 敵システム仕様

### 子敵（現在の赤い敵）
現状の赤い敵を「子敵」として再定義。

#### 基本仕様
- **外観**: 赤いスフィア、エミッシブ発光
- **配置**: 親敵によって動的に配置される
- **配置エフェクト**: 配置直後3秒間は青色で発光、その後赤色に変化
- **生存条件**: 親敵が存在する限り生存、親敵全滅で自動破壊（最大10個同時）

### 親敵A
地球表面を移動しながら子敵を配置する大型敵。

#### 基本仕様
- **サイズ**: 子敵の5倍の球体（HPに比例してサイズ変化、最小1/5）
- **色**: 青色（強化エミッシブ発光 0x0044cc, 強度0.8）
- **HP**: 1250（整数値、蓄積ダメージ型、5倍に強化）
- **移動範囲**: 地球表面全体
- **被弾エフェクト**: 青いポイントライト（自分の2倍サイズ範囲）+ 青いパーティクル

#### 移動システム
- **移動パターン**: 地球表面をランダムに移動
- **移動速度**: 調整可能（実装時に決定）
- **位置固定**: 常に地球表面に接触

#### 子敵配置システム
親敵は移動中に子敵を配置する。

##### 配置ルール
1. **配置条件**: 移動中、可能な位置では必ず子敵を配置
2. **配置制約**: 配置しようとする位置から子敵のポリゴン球直径の5倍以内の距離に他の子敵が存在する場合は配置不可
3. **配置上限**: 地球上の子敵配置数に制限はないが、上記制約により自然に上限が決まる

##### 配置アルゴリズム
```
for 親敵の各位置 {
  配置候補位置 = 親敵の現在位置
  if (配置可能チェック(配置候補位置)) {
    子敵を配置(配置候補位置)
  }
}

配置可能チェック(位置) {
  for 既存の全子敵 {
    距離 = 計算距離(位置, 子敵位置)
    if (距離 < 子敵直径 * 5) {
      return false
    }
  }
  return true
}
```

#### 回復システム
親敵は子敵からエネルギーを受け取ってHPを回復する。

##### 回復条件
1. **距離条件**: 子敵のポリゴン球直径の3倍以内の距離に近づいた場合
2. **連続制限**: ある子敵から連続的にエネルギーをもらうことはできない
3. **解除条件**: 一度他の子敵からエネルギーをもらうと、前の子敵からも再度もらえるようになる
4. **配置直後制限**: 配置直後の子敵からはエネルギーをもらえない（一度他の子敵からエネルギーをもらうと可能になる）

##### 回復仕様
- **回復量**: HP +3
- **回復エフェクト**: 親敵が赤く強いエミッシブで光る → 元の青色に戻る

##### 回復アルゴリズム
```
for 親敵の各フレーム {
  for 範囲内の全子敵 {
    if (距離 < 子敵直径 * 3 && 回復可能(子敵)) {
      親敵HP += 3
      回復エフェクト実行()
      最後に回復した子敵 = 現在の子敵
      break
    }
  }
}

回復可能(子敵) {
  return 子敵 != 最後に回復した子敵 && 
         子敵 != 配置直後の子敵 &&
         少なくとも一度は他の子敵から回復済み
}
```

#### 攻撃システム
親敵はレーザー柱による攻撃を行う。

##### レーザー柱仕様
- **発射位置**: 親敵の背中（地球と反対側）
- **方向**: 空に向かって直線（地球中心から人工衛星方向）
- **形状**: 細いシリンダー状のモデル
- **長さ**: 地球中心から人工衛星までの距離の3倍
- **色**: 青色（親敵と同じ色系統）
- **親子関係**: 親敵に親子付けして移動と同期

##### 攻撃判定
- **対象**: 人工衛星（プレイヤー）
- **ダメージ**: 50（大ダメージ）
- **判定方法**: レーザーシリンダーと人工衛星の衝突判定

## プレイヤーシステム

### プレイヤーHP
- **初期HP**: 100
- **UI表示**: 画面上に数値またはゲージで表示

### ダメージシステム
| 攻撃元 | ダメージ量 | 備考 |
|--------|-----------|------|
| 子敵 | 10 | 現在と同じ |
| 親敵（レーザー） | 50 | 大ダメージ |

### ゲームオーバー
- **条件**: プレイヤーHP が 0 以下
- **現状**: UI上に値を表示のみ（ゲームオーバー処理は今後実装）

### プレイヤー攻撃
- **ダメージ量**: 10（親敵・子敵共通）
- **現在の攻撃システム**: そのまま使用

## UI仕様

### HP表示
1. **プレイヤーHP**: 画面左上に「Player HP: 100」形式で表示
2. **親敵HP**: 親敵数分のHP表示「Parent Enemy 1 HP: 250」「Parent Enemy 2 HP: 180」等

### ステージ表示
- **現在ステージ**: 「Stage: 1」形式で表示
- **進行状況**: 「Enemies: 3/5」（親敵撃破数/総数）

## 技術実装詳細

### ファイル構成
```
js/
├── parent-enemies.js  # ParentEnemySystemクラス（新規作成）
├── enemies.js         # EnemySystemクラス（既存、子敵配置機能統合）
├── player-life.js     # PlayerLifeSystemクラス（新規作成）
├── stage-manager.js   # StageManagerクラス（新規作成）
└── main.js           # 統合・初期化（既存、更新）
```

### 実装順序
1. **Phase A**: ParentEnemySystemクラス、基本移動・HP管理
2. **Phase B**: 子敵配置システム、EnemySystemとの統合
3. **Phase C**: エネルギー回復・レーザー攻撃システム
4. **Phase D**: ステージ管理・UI更新

### データ構造

#### 親敵オブジェクト
```javascript
{
  id: "parent_1",
  mesh: THREE.Mesh,           // 3Dオブジェクト
  hp: 250,                    // 現在HP
  maxHp: 250,                 // 最大HP
  position: THREE.Vector3,    // 地球表面位置
  lastEnergySource: null,     // 最後にエネルギーをもらった子敵ID
  hasReceivedEnergyOnce: false, // 一度でもエネルギーを受け取ったか
  laserCylinder: THREE.Mesh,  // レーザー柱オブジェクト
  isHealing: false,           // 回復中フラグ
  healingTimer: 0             // 回復エフェクト時間
}
```

#### 子敵オブジェクト（既存に追加）
```javascript
{
  // 既存フィールド
  mesh: THREE.Mesh,
  hp: Number,
  // 新規追加フィールド
  placedByParent: "parent_1", // 配置した親敵ID
  placementTime: Number,      // 配置時刻
  hasBeenEnergySource: false  // エネルギー源として使用されたか
}
```

## バランス調整

### 初期パラメータ
- 親敵移動速度: 0.01 rad/sec（調整可能）
- 子敵配置間隔: 0.5秒に1回チェック
- レーザー攻撃間隔: 2秒に1回
- エネルギー回復チェック: 毎フレーム

### 難易度調整要素
1. **親敵移動速度**: 速いほど子敵配置頻度が上がる
2. **回復頻度**: エネルギー受取条件の厳しさ
3. **レーザー攻撃頻度**: プレイヤーへの脅威度
4. **ステージ数・敵数**: ゲーム全体の長さと難易度

### 最新の実装仕様（v2.0）
#### 親敵強化
- **HP**: 1250（5倍強化）
- **サイズ変化**: HP比例で最小1/5まで縮小
- **エミッシブ強化**: 青色 0x0044cc, 強度0.8
- **被弾エフェクト**: 青いポイントライト（自分の2倍範囲） + 青いパーティクル

#### 子敵配置エフェクト
- **配置時**: 青色で3秒間発光
- **通常時**: 赤色エミッシブ発光
- **親敵全滅時**: 最大10個同時で爆破エフェクト付き自動破壊

## 拡張予定

### 将来の親敵バリエーション
- **親敵B**: 異なる移動パターン・攻撃方法
- **親敵C**: 特殊能力（シールド、分裂等）

### ゲーム性拡張
- **武器強化**: ステージクリアによる攻撃力向上
- **ボーナスステージ**: 特殊条件での追加ステージ
- **マルチプレイヤー**: 協力プレイモード