# Ball Attack - 実装計画

## 実装ルール
- 終了した実装フェーズは `HISTORY.md` に移動して保存する
- 現在進行中および未実装の内容はこの `PLAN.md` で管理する
- 完了したフェーズは随時HISTORY.mdに移動すること

## 開発計画概要

### 現在の状況
**完了済み**: Phase 1-7 + 攻撃ゲームフェーズ1 → HISTORY.md に移動済み ✅  
**現在のフェーズ**: **攻撃ゲームフェーズ2** - 双方向戦闘システム（敵の反撃・ライフシステム）  
**将来の目標**: 動的な敵システム、増殖システム、高度なゲームメカニクス

---

## 完了済みシステム概要 ✅

### 基盤システム（完了）
- **軌道球カメラシステム**: ジンバルロック回避、制限なし移動、慣性システム
- **武器システム**: 弾丸発射、攻撃判定、パーティクル爆発、ワイヤーフレーム表示
- **敵システム**: 300体配置、衝突判定、撃破エフェクト、赤いライト・パーティクル
- **サウンドシステム**: 連番自動検出、ランダム再生（発射音、爆発音、撃破音）
- **パラメータ調整UI**: 攻撃範囲、散らばり、物理パラメータのリアルタイム調整

### 技術仕様（完了）
- **攻撃範囲**: 0.095（調整可能：0.02〜0.2）
- **散らばり**: 0.05（調整可能：0.01〜0.2）  
- **敵数**: 300体（地球表面ランダム配置、重複回避）
- **パーティクル**: 軽量PlaneGeometry + Points（最大80個/撃破）
- **確率的撃破**: 中心100%→境界20%の線形ダメージ

---

## 攻撃ゲームフェーズ2: 双方向戦闘システム（次期実装）

### フェーズ2-1: プレイヤーライフシステム
**目標**: プレイヤーの生存要素を追加し、緊張感のある戦闘を実現

#### 実装タスク:
1. **ライフシステム基盤**
   ```javascript
   class PlayerLifeSystem {
     constructor(maxLife = 5)
     takeDamage(amount = 1)
     getCurrentLife()
     isGameOver()
     resetLife()
   }
   ```

2. **ライフUI表示**
   - **ライフ表示**: ハート型アイコン x5 または数値表示
   - **リアルタイム更新**: ダメージ時の即座反映
   - **アニメーション**: ライフ減少時の点滅・色変化エフェクト

3. **ゲームオーバーシステム**
   - **条件**: ライフ0でゲームオーバー
   - **画面**: ゲームオーバー表示、リスタートボタン
   - **統計表示**: 最終スコア、撃破数、生存時間

---

### フェーズ2-2: 敵砲撃システム
**目標**: 敵からプレイヤーへの反撃システム

#### 実装タスク:
1. **EnemyAttackSystemクラス設計**
   ```javascript
   class EnemyAttackSystem {
     constructor(scene, playerTarget, soundSystem)
     checkAttackConditions(enemies, playerPosition)
     fireAtPlayer(enemyPosition, targetPosition)
     updateProjectiles(deltaTime)
     checkPlayerHit(playerCollider)
   }
   ```

2. **攻撃判定・条件**
   - **攻撃角度**: プレイヤーが敵の真上「ある角度」に入った時
     - 判定角度: 敵から人工衛星への仰角が 60°〜90° の範囲
     - 視界判定: 地球による遮蔽を考慮
   - **攻撃頻度**: 条件満足時、2秒に1回の頻度で発射
   - **同時攻撃数**: 最大3体まで同時攻撃可能

3. **敵弾丸仕様**
   - **形状**: 小さなスフィア（半径0.004）
   - **材質**: MeshStandardMaterial（赤色、エミッシブ対応）
   - **発光**: 明るさが点滅する動的エフェクト（sin波使用）
   - **速度**: プレイヤー弾と同等（0.15）
   - **軌道**: 高射砲風の弾道、若干の散らばり

---

### フェーズ2-3: 人工衛星衝突判定システム
**目標**: プレイヤーへのダメージシステム

#### 実装タスク:
1. **プレイヤーコリジョン設計**
   ```javascript
   class PlayerCollider {
     constructor(playerObject, radius)
     updatePosition(playerWorldPosition)
     checkCollision(enemyProjectiles)
     triggerDamageEffect()
   }
   ```

2. **衝突判定仕様**
   - **コリジョン球**: 人工衛星と同サイズの見えない球体
   - **半径**: 人工衛星のサイズに合わせて適切に設定
   - **判定**: 敵弾丸とコリジョン球の3D距離計算
   - **ダメージ**: 1発につきライフ-1

3. **ダメージエフェクト**
   - **画面フラッシュ**: 画面全体が赤く点滅（0.3秒間）
   - **カメラシェイク**: 軽い振動エフェクト
   - **ダメージ音**: 専用のダメージ音再生
   - **ライフUI更新**: ハートの減少アニメーション

---

### フェーズ2-4: 戦術要素の追加
**目標**: より戦略的なゲームプレイ

#### 実装タスク:
1. **敵の狙撃優先度**
   - **危険度判定**: プレイヤーに攻撃中の敵を優先表示
   - **視覚的警告**: 攻撃準備中の敵の色変化・点滅
   - **攻撃予告**: 敵が攻撃する1秒前に警告エフェクト

2. **回避戦術**
   - **移動による回避**: 敵の攻撃角度から外れることで攻撃回避
   - **攻撃タイミング**: 敵の攻撃準備中に撃破することで攻撃キャンセル
   - **生存ボーナス**: 長時間生存でスコアボーナス

---

## 技術仕様詳細

### 座標系・衝突判定
- **地球**: 中心 (0, 0, 0)、半径 1
- **敵配置**: 地球表面 + 0.005のオフセット
- **プレイヤー**: 軌道半径1.3の軌道上移動
- **攻撃角度計算**: 敵→プレイヤーベクトルと地表法線の角度

### ファイル構成（更新予定）
```
ball_attack/
├── js/
│   ├── main.js          ✅ # 既存：ゲーム統合
│   ├── controls.js      ✅ # 既存：カメラ制御
│   ├── weapons.js       ✅ # 既存：プレイヤー武器
│   ├── enemies.js       ✅ # 既存：敵システム
│   ├── sound.js         ✅ # 既存：サウンド
│   ├── utils.js         ✅ # 既存：ユーティリティ
│   ├── enemy-attack.js   # 新規：敵攻撃システム
│   ├── player-life.js    # 新規：ライフシステム
│   └── damage-effects.js # 新規：ダメージエフェクト
```

### 実装優先順位
1. **最優先**: フェーズ2-1（ライフシステム基盤）
2. **高優先**: フェーズ2-2（敵砲撃システム）
3. **高優先**: フェーズ2-3（衝突判定・ダメージ）
4. **中優先**: フェーズ2-4（戦術要素）

### パフォーマンス目標
- **フレームレート**: 60fps維持（敵300体 + 敵弾10発 + プレイヤー弾50発）
- **メモリ使用量**: 120MB以下（エフェクト増加分考慮）
- **反応性**: 攻撃判定1ms以内、ダメージエフェクト即座反映

---

## 攻撃ゲームフェーズ3: 動的敵システム（将来実装）

### フェーズ3-1: 敵移動システム
**実装予定**:
1. **球面移動アルゴリズム**
   - 大円経路による自然な移動
   - ランダムウォーク + 方向転換
   - 地形に応じた速度変化

2. **移動パターン**
   - 直線移動型（速度0.01/秒）
   - ジグザグ移動型（回避行動）
   - 群れ移動型（複数敵の連携）

### フェーズ3-2: 敵AI・行動システム
**実装予定**:
1. **回避行動**
   - 弾丸接近感知
   - 予測回避アルゴリズム
   - 地形を利用した隠蔽

2. **増殖システム**
   - 時間経過による敵分裂
   - 撃破されない敵の自己複製
   - 最大敵数制限（300体）

---

## 攻撃ゲームフェーズ4: 高度なゲームメカニクス（将来実装）

### フェーズ4-1: 敵種別システム
**実装予定**:
1. **敵タイプ多様化**
   - 小型敵（高速移動、低耐久、高攻撃頻度）
   - 大型敵（低速移動、高耐久、強力攻撃）
   - ボス敵（特殊攻撃、大量HP、複数攻撃パターン）

2. **特殊能力**
   - シールド敵（一定時間無敵）
   - 分裂敵（撃破時に2体に分裂）
   - テレポート敵（瞬間移動）

### フェーズ4-2: ウェーブシステム
**実装予定**:
1. **ステージ進行**
   - Wave 1: 300体の静的敵（現在の仕様）
   - Wave 2: 200体の移動敵 + 攻撃敵
   - Wave 3: 100体の高速敵 + ボス1体

2. **難易度調整**
   - ウェーブごとの敵数・攻撃頻度増加
   - 敵速度・耐久力の向上
   - プレイヤー武器強化システム

---

## 次のステップ（フェーズ2実装時）
1. `js/player-life.js` の作成
2. PlayerLifeSystemクラスの実装
3. ライフUI表示の追加
4. `js/enemy-attack.js` の作成
5. EnemyAttackSystemクラスの実装
6. 敵弾丸システムの実装
7. プレイヤーコリジョン判定の追加
8. ダメージエフェクトシステムの実装
9. ゲームオーバー画面の作成