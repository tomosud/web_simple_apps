# Ball Attack - 実装計画

## 開発計画概要

### フェーズ別実装計画

**現在の状況**: Phase 6まで完了 - 攻撃システム実装完了 ✅
**次のフェーズ**: Phase 7 - 敵システム実装

#### Phase 1: 軌道球カメラシステム (完了) ✅
**目標**: 地球をトラックボールのように操作できるカメラシステム

**実装完了内容**:
1. **基本3Dシーン** ✅
   - Three.js シーン、カメラ、レンダラー初期化
   - 地球オブジェクト（SphereGeometry, 高解像度テクスチャ）
   - ライティングシステム（環境光、指向性ライト、ポイントライト）

2. **軌道球制御システム** ✅
   - **軌道球（orbitSphere）**: 見えない制御用オブジェクト（地球中心）
   - **人工衛星**: 軌道球の子として配置、円錐形状
   - **カメラマウント**: 軌道球の子として配置、カメラ位置制御用
   - **親子関係**: 軌道球の回転により人工衛星とカメラが同期移動

3. **慣性システム** ✅
   - **質量**: 100.0（重い石玉のような操作感）
   - **基本摩擦**: 0.98（高速時は等速度運動）
   - **低速域摩擦**: 0.95（速度0.005以下で自動停止）
   - **停止閾値**: 0.0001（完全停止判定）
   - **速度依存制御**: 動いている時は加速しやすく、止まっている時は重く

4. **カメラ制御システム** ✅
   - **カメラ座標系ベース**: スクリーンスペース固定の直感的操作
   - **モード別入力切り替え**: デバッグ/カメラモードで最適化
   - **ジンバルロック回避**: クォータニオンベースの回転制御
   - **制限なし移動**: 極地を含む全方向へ自由移動

5. **ズーム制御システム** ✅
   - **軌道半径慣性**: 質量20.0、摩擦0.9の物理的な半径変更
   - **マウスホイール**: PC用、3倍速で高速対応
   - **ピンチジェスチャ**: スマホ用、タッチ操作最適化
   - **範囲制限**: 1.1～3.0の軌道半径

6. **デバッグシステム** ✅
   - **デバッグモード**: 人工衛星表示、カメラ固定位置
   - **カメラモード**: 人工衛星非表示、カメラが軌道位置
   - **切り替え**: Dキーでモード切り替え
   - **物理パラメータUI**: リアルタイム調整可能

**技術的解決策**:
- **ジンバルロック問題**: 軌道球＋クォータニオン回転で完全回避
- **極地制限問題**: 制限なしのカメラ移動で解決
- **操作感問題**: 慣性システム＋速度依存制御で自然な動き
- **スマホ対応**: passive: false、ピンチジェスチャ対応

**物理パラメータ詳細**:
- **慣性システム**: 重い石玉を転がすような動き
- **等速度運動**: 高速時は摩擦なしで永続的な動き
- **自動停止**: 低速域で自然な停止
- **クリック減速**: 直感的な停止操作

#### Phase 2: 敵システム (未実装)
**目標**: 地球表面を移動する敵点群

**実装タスク**:
1. **敵クラス設計**
   ```javascript
   class Enemy {
     constructor(lat, lng, speed, direction)
     update(deltaTime)
     getWorldPosition() // 緯度経度→3D座標変換
   }
   ```

2. **敵生成システム**
   - ランダム位置での敵スポーン
   - 最大敵数制限 (50-100体)
   - 経時的な敵増加システム

3. **移動アルゴリズム**
   - 球面上の移動（大円経路）
   - 方向転換ロジック
   - 地球表面への吸着

4. **レンダリング最適化**
   - `sample/js/instanced-rendering.js` を参考
   - InstancedMesh での大量描画
   - LOD システム適用

**技術詳細**:
- 緯度経度→3D座標変換関数
- 球面三角法による移動計算
- インスタンス化レンダリングで高パフォーマンス

#### Phase 3: 弾システム (完了) ✅
**目標**: 高度な弾丸・エフェクトシステム

**実装完了内容**:
1. **WeaponSystemクラス** ✅
   - 弾丸オブジェクトプール（最大50発）
   - パーティクル爆発エフェクト
   - ポイントライト点灯エフェクト（最大3個同時）
   - ワイヤーフレーム範囲表示機能
   - 弾丸寿命管理（10秒、地表到達保証）

2. **発射システム** ✅
   - 人工衛星両側に銃を配置（0.15間隔）
   - 0.15秒間隔での交互発射
   - 人工衛星から地球への収束弾道
   - スペースキー（PC）、タッチボタン（スマホ）

3. **弾道物理** ✅
   - 基本直線移動 + 個別ランダム振動（アンチエアクラフト砲風）
   - 周期的ノイズによるリアルな軌道（周期3倍拡大）
   - 地球半径での衝突判定
   - オブジェクトプールによる最適化

4. **ビジュアルエフェクト** ✅
   - 黄色発光弾丸（MeshStandardMaterial、エミッシブ対応）
   - パーティクル爆発（重力なし、加算ブレンド）
   - ポイントライト点灯（重複回避、性能最適化）
   - 攻撃判定球ワイヤーフレーム表示（Wキーで切り替え）

5. **攻撃判定システム** ✅
   - 全着弾位置に攻撃判定球を生成
   - 範囲半径0.06（ポイントライト範囲と連動）
   - 中心部致死性100%、境界部致死性20%の線形補間ダメージ
   - デバッグ用0.3秒表示、実戦用1フレーム有効

**技術詳細**:
- 人工衛星座標系ベースの発射位置計算
- 個別弾丸ランダム振動システム
- 距離ベースポイントライト重複回避
- 距離ベース線形補間ダメージ計算
- パフォーマンス最適化（オブジェクトプール、フレーム間引き）

#### Phase 4: 当たり判定・ゲームロジック (部分完了) ✅
**目標**: 弾と敵の衝突判定・スコアシステム

**実装完了内容**:
1. **衝突判定システム** ✅
   - 弾丸と地球の衝突判定
   - 距離計算による高速判定
   - 衝突時の弾丸削除システム

2. **エフェクトシステム** ✅
   - 爆発エフェクト（球体拡大）
   - 透明度変化アニメーション
   - エフェクトオブジェクトプール

**未実装（Phase 2依存）**:
- 敵との衝突判定
- スコアシステム
- 敵撃墜カウント
- レベル進行システム

**技術詳細**:
- 球体-球体衝突判定（基本実装済み）
- オブジェクトプールによる効率化

#### Phase 5: UI・UXシステム (未実装)
**目標**: ゲームUI・メニュー・スコア表示

**実装タスク**:
1. **ゲームUI**
   - スコア表示
   - 敵撃墜数表示
   - レベル/ウェーブ表示

2. **メニューシステム**
   - スタート画面
   - ゲームオーバー画面
   - ポーズ機能

3. **レスポンシブデザイン**
   - スマホ UI 最適化
   - タッチ操作最適化
   - 画面サイズ適応

**参考**: `sample/index.html` のレスポンシブCSS

#### Phase 6: 最適化・エフェクト (未実装)
**目標**: パフォーマンス最適化・視覚効果

**実装タスク**:
1. **パフォーマンス最適化**
   - フラスタムカリング
   - LOD システム
   - ガベージコレクション最適化

2. **視覚エフェクト**
   - 地球の大気効果
   - リムライティング
   - パーティクルエフェクト

3. **サウンドシステム**
   - 発射音
   - 爆発音
   - 背景音楽

**参考コード**:
- `sample/js/performance.js` - パフォーマンス監視
- `sample/js/effects.js` - エフェクトシステム

## 技術仕様詳細

### 軌道球制御システム詳細

#### 軌道球アーキテクチャ
```javascript
// 軌道球（見えない制御用オブジェクト）
this.orbitSphere = new THREE.Object3D();
this.orbitSphere.position.set(0, 0, 0); // 地球中心

// 人工衛星（軌道球の子）
this.satellite.position.set(0, 0, this.satelliteOrbitRadius);
this.orbitSphere.add(this.satellite);

// カメラマウント（軌道球の子）
this.cameraMount.position.set(0, 0, this.satelliteOrbitRadius - 0.2);
this.orbitSphere.add(this.cameraMount);
```

#### 慣性システム詳細
```javascript
// 物理パラメータ
this.mass = 100.0;              // 質量（重い設定）
this.baseFriction = 0.98;       // 基本摩擦（高速時）
this.frictionStrength = 0.08;   // 追加摩擦強度
this.lowSpeedThreshold = 0.005; // 低速域閾値
this.stopThreshold = 0.0001;    // 停止閾値

// 低速域摩擦システム
if (currentSpeed < lowSpeedThreshold && currentSpeed > 0) {
    const friction = 0.95;
    this.velocity.x *= friction;
    this.velocity.y *= friction;
}
```

#### カメラ制御システム詳細
```javascript
// カメラ座標系ベース回転
const cameraRight = new THREE.Vector3(1, 0, 0).applyQuaternion(this.camera.quaternion);
const cameraUp = new THREE.Vector3(0, 1, 0).applyQuaternion(this.camera.quaternion);

// 水平/垂直ドラッグの回転軸
const rotationHorizontal = new THREE.Quaternion().setFromAxisAngle(cameraUp, -adjustedVelocityX);
const rotationVertical = new THREE.Quaternion().setFromAxisAngle(cameraRight, -adjustedVelocityY);
```

### 座標系統一
- **地球**: 中心 (0, 0, 0)、半径 1
- **軌道球**: 地球中心に配置、回転のみ
- **人工衛星**: 軌道球の子、Z軸上に配置
- **カメラマウント**: 軌道球の子、人工衛星より地球側

### 攻撃判定システム詳細

#### 攻撃判定球仕様
```javascript
// 攻撃判定球の基本設定
this.attackRange = 0.06;    // 攻撃範囲半径（ポイントライト範囲と連動）
this.centerDamage = 1.0;    // 中心部致死性100%
this.borderDamage = 0.2;    // 境界部致死性20%

// ダメージ計算（距離ベース線形補間）
calculateDamage(distance) {
  if (distance > this.attackRange) return 0;
  const damageRatio = 1.0 - (distance / this.attackRange);
  return this.borderDamage + (this.centerDamage - this.borderDamage) * damageRatio;
}
```

#### 使用モード
- **デバッグモード**: 0.3秒間ワイヤーフレーム表示（視覚確認用）
- **実戦モード**: 1フレームのみ有効（敵との当たり判定用）
- **範囲連動**: 攻撃範囲変更時、ポイントライト範囲も自動更新

### 座標変換関数
```javascript
// 緯度経度→3D座標（utils.js内）
function latLngToCartesian(lat, lng, radius = 1) {
  const phi = (90 - lat) * Math.PI / 180;
  const theta = (lng + 180) * Math.PI / 180;
  return new THREE.Vector3(
    radius * Math.sin(phi) * Math.cos(theta),
    radius * Math.cos(phi),
    radius * Math.sin(phi) * Math.sin(theta)
  );
}
```

### パフォーマンス仕様
- **フレームレート**: 60fps目標
- **レンダリング**: WebGL、アンチエイリアス有効
- **テクスチャ**: 高解像度地球テクスチャ（5400x2700）
- **メモリ使用量**: 軽量設計

### ファイル構成
```
ball_attack/
├── index.html              ✅ # メインHTML、物理パラメータUI
├── js/
│   ├── main.js            ✅ # BallAttackGameクラス、軌道球システム、攻撃システム統合
│   ├── controls.js        ✅ # SatelliteOrbitControlsクラス、慣性システム
│   ├── utils.js           ✅ # ユーティリティ関数、パフォーマンス監視
│   ├── weapons.js         ✅ # WeaponSystemクラス、弾丸・爆発システム
│   ├── enemies.js          # 敵システム (Phase 2)
│   ├── collision.js        # 当たり判定 (Phase 4 - 敵システム)
│   ├── ui.js              # UIシステム (Phase 5)
│   ├── effects.js         # エフェクトシステム (Phase 6)
│   └── performance.js     # パフォーマンス最適化 (Phase 6)
├── css/
│   └── style.css          ✅ # メインスタイル、レスポンシブデザイン
└── assets/
    ├── world.topo.bathy.200412.3x5400x2700.jpg ✅ # 高解像度地形テクスチャ
    └── sounds/             # サウンドファイル (Phase 6)
```

**Phase 1-6完了ファイル**:
- ✅ `index.html` - 基本HTML構造、物理パラメータUI、発射ボタン、レスポンシブデザイン
- ✅ `css/style.css` - ゲームUI、モバイル対応スタイル、発射ボタンデザイン
- ✅ `js/main.js` - BallAttackGameクラス、軌道球システム、攻撃システム統合、ワイヤーフレーム切り替え
- ✅ `js/controls.js` - SatelliteOrbitControlsクラス、慣性システム、カメラ制御
- ✅ `js/utils.js` - ユーティリティ関数、パフォーマンス監視、リソース管理
- ✅ `js/weapons.js` - WeaponSystemクラス、弾丸管理、パーティクル爆発、ポイントライト、ワイヤーフレーム範囲表示
- ✅ `assets/world.topo.bathy.200412.3x5400x2700.jpg` - 高解像度地球テクスチャ

### キーボードショートカット
- **F**: 軌道球位置リセット
- **D**: デバッグモード切り替え（人工衛星表示/非表示）
- **R**: ゲームリセット
- **スペースキー**: 弾丸発射（PC用）
- **W**: ワイヤーフレーム範囲表示切り替え（攻撃範囲確認用）

### 操作方法
- **ドラッグ**: 軌道球回転（地球をトラックボールのように操作）
- **クリック**: 速度減衰（動きを止める）
- **マウスホイール**: 軌道半径変更（ズーム）
- **ピンチジェスチャ**: スマホでの軌道半径変更
- **スペースキー**: 弾丸発射（PC用）
- **発射ボタン**: 弾丸発射（スマホ用）

### 物理パラメータ調整
- **摩擦強度**: 0.01～0.3（リアルタイム調整）
- **質量**: 10～200（重い動きの調整）
- **基本摩擦**: 0.90～0.99（減衰の調整）

## テスト計画
1. **各フェーズ後の動作確認**
2. **複数ブラウザでのテスト**
3. **スマホ・タブレットでの操作テスト**
4. **パフォーマンステスト**
5. **GitHub Pages デプロイテスト**

## デプロイメント
- GitHub Pages での静的ホスティング
- 全ファイルが相対パスで動作
- CDN依存は Three.js のみ
