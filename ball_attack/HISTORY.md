# Ball Attack - 実装履歴

## 実装ルール
終了した実装フェーズはこのHISTORY.mdファイルに移動して保存する。
現在進行中および未実装の内容はPLAN.mdで管理する。

## 完了済み実装履歴

### Phase 1: 軌道球カメラシステム (完了) ✅
**目標**: 地球をトラックボールのように操作できるカメラシステム

**実装完了内容**:
1. **基本3Dシーン** ✅
   - Three.js シーン、カメラ、レンダラー初期化
   - 地球オブジェクト（SphereGeometry, 高解像度テクスチャ）
   - ライティングシステム（環境光、指向性ライト、ポイントライト）

2. **軌道球制御システム** ✅
   - **軌道球（orbitSphere）**: 見えない制御用オブジェクト（地球中心）
   - **人工衛星**: 軌道球の子として配置、円錐形状
   - **カメラマウント**: 軌道球の子として配置、カメラ位置制御用
   - **親子関係**: 軌道球の回転により人工衛星とカメラが同期移動

3. **慣性システム** ✅
   - **質量**: 100.0（重い石玉のような操作感）
   - **基本摩擦**: 0.98（高速時は等速度運動）
   - **低速域摩擦**: 0.95（速度0.0025以下で自動停止）
   - **停止閾値**: 0.0001（完全停止判定）
   - **速度依存制御**: 動いている時は加速しやすく、止まっている時は重く

4. **カメラ制御システム** ✅
   - **カメラ座標系ベース**: スクリーンスペース固定の直感的操作
   - **モード別入力切り替え**: デバッグ/カメラモードで最適化
   - **ジンバルロック回避**: クォータニオンベースの回転制御
   - **制限なし移動**: 極地を含む全方向へ自由移動

5. **ズーム制御システム** ✅
   - **軌道半径慣性**: 質量20.0、摩擦0.9の物理的な半径変更
   - **マウスホイール**: PC用、3倍速で高速対応
   - **ピンチジェスチャ**: スマホ用、タッチ操作最適化
   - **範囲制限**: 1.1～3.0の軌道半径

6. **デバッグシステム** ✅
   - **デバッグモード**: 人工衛星表示、カメラ固定位置
   - **カメラモード**: 人工衛星非表示、カメラが軌道位置
   - **切り替え**: Dキーでモード切り替え
   - **物理パラメータUI**: リアルタイム調整可能

### Phase 2: 弾丸システム (完了) ✅
**目標**: 高度な弾丸・エフェクトシステム

**実装完了内容**:
1. **WeaponSystemクラス** ✅
   - 弾丸オブジェクトプール（最大50発）
   - パーティクル爆発エフェクト
   - ポイントライト点灯エフェクト（最大3個同時）
   - ワイヤーフレーム範囲表示機能
   - 弾丸寿命管理（10秒、地表到達保証）

2. **発射システム** ✅
   - 人工衛星両側に銃を配置（0.075間隔）
   - 0.15秒間隔での交互発射
   - 人工衛星から地球への収束弾道
   - スペースキー（PC）、タッチボタン（スマホ）

3. **弾道物理** ✅
   - 基本直線移動 + 個別ランダム振動（アンチエアクラフト砲風）
   - 周期的ノイズによるリアルな軌道（周期3倍拡大）
   - 地球半径での衝突判定
   - オブジェクトプールによる最適化

4. **ビジュアルエフェクト** ✅
   - 黄色発光弾丸（MeshStandardMaterial、エミッシブ対応）
   - パーティクル爆発（重力なし、加算ブレンド）
   - ポイントライト点灯（重複回避、性能最適化）
   - 攻撃判定球ワイヤーフレーム表示（Wキーで切り替え）

5. **攻撃判定システム** ✅
   - 全着弾位置に攻撃判定球を生成
   - 範囲半径0.036（ポイントライト範囲と連動）
   - 中心部致死性100%、境界部致死性20%の線形補間ダメージ
   - デバッグ用0.3秒表示、実戦用1フレーム有効

### Phase 3: サウンドシステム (完了) ✅
**目標**: 音響効果システムの実装

**実装完了内容**:
1. **SoundSystemクラス** ✅
   - 発射音（Canon01.wav, Canon02.wav をランダム再生）
   - 爆発音（impact01.wav を地表衝突時に再生）
   - 音量係数による全体音量制御
   - 同時再生数制限（最大64個）

2. **武器システム連携** ✅
   - 弾丸発射時の発射音自動再生
   - 地表衝突時の爆発音自動再生
   - 左右の銃からランダムな発射音

## 完了済みファイル一覧

### Core Files (完了) ✅
- ✅ `index.html` - 基本HTML構造、物理パラメータUI、発射ボタン、レスポンシブデザイン、サウンドシステム読み込み
- ✅ `css/style.css` - ゲームUI、モバイル対応スタイル、発射ボタンデザイン
- ✅ `js/main.js` - BallAttackGameクラス、軌道球システム、攻撃システム統合、サウンドシステム統合
- ✅ `js/controls.js` - SatelliteOrbitControlsクラス、慣性システム、カメラ制御
- ✅ `js/utils.js` - ユーティリティ関数、パフォーマンス監視、リソース管理
- ✅ `js/weapons.js` - WeaponSystemクラス、弾丸管理、パーティクル爆発、発射音・爆発音連携
- ✅ `js/sound.js` - SoundSystemクラス、発射音・爆発音管理

### Assets (完了) ✅
- ✅ `assets/world.topo.bathy.200412.3x5400x2700.jpg` - 高解像度地球テクスチャ
- ✅ `assets/sound/Canon01.wav` - 発射音1
- ✅ `assets/sound/Canon02.wav` - 発射音2
- ✅ `assets/sound/impact01.wav` - 爆発音
- ✅ `assets/sound/Swipe.wav` - UI音（使用停止）

## 技術的達成事項

### 軌道球システム詳細
- **ジンバルロック問題**: 軌道球＋クォータニオン回転で完全回避
- **極地制限問題**: 制限なしのカメラ移動で解決
- **操作感問題**: 慣性システム＋速度依存制御で自然な動き
- **スマホ対応**: passive: false、ピンチジェスチャ対応

### 物理パラメータ詳細
- **慣性システム**: 重い石玉を転がすような動き
- **等速度運動**: 高速時は摩擦なしで永続的な動き
- **自動停止**: 低速域で自然な停止
- **クリック減速**: 直感的な停止操作

### 攻撃判定システム詳細
- **攻撃判定球の基本設定**: 攻撃範囲半径0.036（ポイントライト範囲と連動）
- **ダメージ計算**: 距離ベース線形補間（中心100%→境界20%）
- **使用モード**: デバッグモード（0.3秒表示）、実戦モード（1フレーム有効）
- **範囲連動**: 攻撃範囲変更時、ポイントライト範囲も自動更新

### 座標変換関数
```javascript
// 緯度経度→3D座標（utils.js内）
function latLngToCartesian(lat, lng, radius = 1) {
  const phi = (90 - lat) * Math.PI / 180;
  const theta = (lng + 180) * Math.PI / 180;
  return new THREE.Vector3(
    radius * Math.sin(phi) * Math.cos(theta),
    radius * Math.cos(phi),
    radius * Math.sin(phi) * Math.sin(theta)
  );
}
```

### キーボードショートカット
- **F**: 軌道球位置リセット
- **D**: デバッグモード切り替え（人工衛星表示/非表示）
- **R**: ゲームリセット
- **スペースキー**: 弾丸発射（PC用）
- **W**: ワイヤーフレーム範囲表示切り替え（攻撃範囲確認用）

### 操作方法
- **ドラッグ**: 軌道球回転（地球をトラックボールのように操作）
- **クリック**: 速度減衰（動きを止める）
- **マウスホイール**: 軌道半径変更（ズーム）
- **ピンチジェスチャ**: スマホでの軌道半径変更
- **スペースキー**: 弾丸発射（PC用）
- **発射ボタン**: 弾丸発射（スマホ用）

### パフォーマンス仕様
- **フレームレート**: 60fps目標
- **レンダリング**: WebGL、アンチエイリアス有効
- **テクスチャ**: 高解像度地球テクスチャ（5400x2700）
- **メモリ使用量**: 軽量設計、オブジェクトプール活用