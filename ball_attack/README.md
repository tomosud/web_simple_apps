# Ball Attack - 地球シューティングゲーム

## 概要
Three.jsを使用した地球シューティングゲーム。プレイヤーは地球をトラックボールのようにドラッグで回転させ、地球上の敵を狙い撃つゲームです。実装では地球が固定され、カメラ側が動くことでトラックボール操作を再現しています。

## システム仕様

### 基本コンセプト
- **ゲーム目標**: 地球をトラックボールのように操作し、地球上の敵を撃つシューティングゲーム
- **実装方式**: 地球は画面中央に固定、カメラ側が動いてトラックボール操作を再現
- **軌道球システム**: 見えない軌道球を作成し、カメラを親子付けすることで制御
- **人工衛星モード**: デバッグ用に人工衛星（緑色の円錐）を表示し、動きを確認できる

### プレイヤー操作

#### トラックボール操作（カメラ回転）
- **ドラッグ**: 地球をトラックボールのように回転（実際はカメラが動く）
- **クリック**: 回転速度を減衰させて停止
- **慣性システム**: ドラッグ終了後も慣性で回転し続け、徐々に停止
- **重い石玉のような動き**: 質量設定で重く、動き始めは遅く、一度動けば永続的
- **等速度運動**: 高速時は摩擦なしで永続的に動き続ける
- **低速域摩擦**: 低速時は自然な停止

#### 地球表示（画面フィット）
- **自動フィット**: 画面の短い方の辺に地球をフィット
- **縦横対応**: 縦画面・横画面どちらでも最適表示
- **距離固定**: ズーム操作廃止、リサイズ時自動調整

#### タッチ操作調整UI
- **ドラッグ感度**: 調整可能範囲（リアルタイム調整）
- **デバイス判定**: PC/スマホで自動的に最適化
- **UI保護**: スライダー操作時の射撃干渉防止

#### 慣性システム詳細
- **物理モデル**: 重い石玉を転がすような動き
- **速度依存制御**: 動いている時は加速しやすく、止まっている時は重く
- **二段階摩擦**: 高速時は等速度運動、低速時は摩擦で停止
- **直感的操作**: カメラ座標系ベースのスクリーンスペース固定操作

### 技術仕様

#### 軌道球システム詳細
- **軌道球（orbitSphere）**: 見えない制御用オブジェクト、地球中心に配置
- **人工衛星**: 軌道球の子、デバッグ用表示
- **カメラマウント**: 軌道球の子、カメラ位置制御用
- **親子関係**: 軌道球の回転により全体が同期回転

#### 物理システム
- **クォータニオンベース**: ジンバルロック回避で滑らかな回転
- **速度依存制御**: 止まっている時は動きにくく、動いている時は加速しやすい
- **慣性システム**: 質量設定による重い石玉のような動き、低速域摩擦、高速域は等速度運動
- **軌道半径慣性**: 滑らかなズーム制御
- **カメラ座標系ベース**: スクリーンスペース固定の直感的操作

#### 使用技術
- **レンダリング**: Three.js、WebGL、アンチエイリアス有効
- **地球描画**: SphereGeometry + 高解像度地形テクスチャ
- **人工衛星**: ConeGeometry（緑色の円錐、デバッグ用）
- **軌道制御**: クォータニオンベースの軌道球制御システム
- **姿勢制御**: カメラ座標系ベースでジンバルロック回避

#### ファイル構成
```
ball_attack/
├── index.html          # メインHTML + タッチ操作UI + ハート表示
├── js/
│   ├── main.js         # BallAttackGameクラス、画面フィット機能、UI要素判定
│   ├── controls.js     # SatelliteOrbitControlsクラス、タッチ感度調整
│   ├── weapons.js      # WeaponSystemクラス、針状弾丸、進行方向制御
│   ├── enemies.js      # EnemySystemクラス、敵配置・撃破システム
│   ├── enemy-attack.js # EnemyAttackSystemクラス、敵弾丸システム
│   ├── parent-enemies.js # ParentEnemySystemクラス、親敵システム
│   ├── player-life.js  # PlayerLifeSystemクラス、ハートライフ管理
│   ├── stage-system.js # StageSystemクラス、ステージ進行管理
│   ├── sound.js        # SoundSystemクラス、発射音・爆発音・撃破音管理
│   └── utils.js        # ユーティリティ関数、パフォーマンス監視
├── assets/
│   ├── world.topo.bathy.200412.3x5400x2700.jpg  # 高解像度地球テクスチャ
│   └── sound/          # サウンドファイル（Canon01-02, impact01-02, hit01-02）
├── css/
│   └── style.css       # レスポンシブスタイル、ハート・ゲームオーバー画面
├── README.md           # プロジェクト概要・現在の状態
├── HISTORY.md          # 完了済み開発履歴
└── PLAN.md             # 今後の実装計画
```

#### レスポンシブ対応
- スマートフォン・タブレット・PC対応
- タッチ操作とマウス操作の統合
- 画面比率に応じた自動フィット
- デバイス別感度調整

### 操作ガイド

#### 基本操作
- **ドラッグ**: 軌道上での移動（スクリーンスペース固定の直感的操作）
- **クリック**: 速度を減衰（動きを止めたい時）

#### 射撃操作
- **マウス左クリック**: 弾丸発射（クリック中は連続射撃）
- **タッチ**: スマホでの弾丸発射（タッチ中は連続射撃）
- **UI要素**: スライダーやボタンは射撃と干渉しないよう保護

#### キーボードショートカット
- **F**: 人工衛星位置リセット
- **D**: デバッグモード切り替え
- **R**: ゲームリセット
- **W**: ワイヤーフレーム範囲表示切り替え（攻撃範囲確認用）

#### 物理挙動の特徴
- **動き始め**: 重く、反応が鈍い（静止時は特に重い）
- **高速時**: 等速度運動で止まりにくい
- **低速時**: 自動的に摩擦が働いて停止
- **ズーム**: 慣性のある滑らかな半径変更（高速化）
- **操作方向**: どの角度でも一貫したスクリーンスペース操作
- **モード別操作**: 人工衛星モード（上下調整）、カメラモード（左右調整）

### 実装完了内容

#### Phase 1-3: 基盤システム ✅
- **軌道球カメラシステム**: Three.js + クォータニオン制御
- **慣性システム**: 重い石玉物理モデル、等速度運動
- **カメラ制御**: ジンバルロック回避、スクリーンスペース固定

#### Phase 4-5: 攻撃・サウンドシステム ✅
- **弾丸システム**: 針状弾丸、進行方向制御、オブジェクトプール
- **サウンドシステム**: 発射音・爆発音・撃破音のランダム再生
- **攻撃判定**: 範囲ダメージ、ワイヤーフレーム表示

#### Phase 6-7: 敵システム・ビジュアル改善 ✅
- **敵配置システム**: 300個の赤いエネミー、撃破エフェクト
- **敵弾丸システム**: 緑色針状弾丸、反撃システム
- **ビジュアル強化**: エミッシブ発光、弾丸形状最適化

#### Phase 8: 操作方法改修 ✅
- **射撃方式変更**: スペースキー廃止 → マウスクリック/タッチ
- **ズーム機能廃止**: 画面フィット機能に置き換え
- **画面フィット**: 短い辺基準の自動調整
- **UI要素保護**: スライダー操作時の射撃干渉防止

#### Phase 9: タッチ操作最適化 ✅
- **感度調整UI**: 1-100段階のドラッグ感度設定
- **デバイス判定**: PC/スマホ自動識別・最適化
- **UI統合**: 不要なパラメータUI非表示化

**技術的特徴**:
- **画面フィット機能**: 短い辺基準の自動調整
- **タッチ感度調整**: デバイス別最適化とリアルタイム調整
- **UI要素保護**: 操作干渉防止システム
- **針状弾丸**: 進行方向制御とビジュアル最適化
- **統合操作**: マウス・タッチの統一インターフェース
- **マルチプラットフォーム**: PC・スマホ・タブレット完全対応

## 現在の状態

### ゲーム完成度: ライフ・ステージシステム実装済み ✅
- **コアゲーム**: 地球シューティングゲームとして完全動作
- **敵システム**: 親敵による子敵配置システム、撃破システム、反撃システム
- **ライフシステム**: ハート3つ表示、ダメージでハート減少、ゲームオーバー画面
- **ステージシステム**: ステージクリア、次ステージで親敵数増加（最大5体）
- **操作性**: PC・スマホ最適化、直感的操作
- **ビジュアル**: 針状弾丸、エフェクト、サウンド統合

### 今後の拡張可能性
詳細は `PLAN.md` を参照

## 実装済み: 親敵・子敵システム

### ゲームサイクル
ステージ制のゲーム進行システム。親敵をすべて倒すと子敵も壊滅してステージクリア。

#### ステージ構成
- 親敵数に応じたステージ構成
- 初期配置子敵なし、親敵が動的に配置
- 親敵全滅で子敵も自動破壊

### 敵システム仕様

#### 子敵（赤い敵）
- 親敵によって動的に配置される存在
- 配置直後は青色で発光、時間経過で赤色に変化
- 親敵が全滅すると子敵も壊滅

#### 親敵（青い大型敵）
- **サイズ**: 子敵の数倍の球体（HP比例でサイズ変化）
- **色**: 青色（エミッシブ発光）
- **HP**: 高耐久（プレイヤー攻撃で減少）
- **移動**: 地球表面を動き回る
- **子敵配置**: 可能な位置に子敵を配置
  - 配置制約: 既存子敵との距離制約あり
- **回復システム**: 子敵からエネルギー受取でHP回復
  - 条件: 距離制約、同一子敵から連続受取不可
  - エフェクト: 回復時に赤く強いエミッシブ発光
- **攻撃**: レーザー柱（背中から空に向かう青いレーザー）
  - 形状: 細いシリンダー状
  - ダメージ: プレイヤーに大ダメージ

### プレイヤーシステム
- **ライフシステム**: ハート3つでライフ表示
- **ダメージ処理**: 被弾時ハート減少、点滅アニメーション
- **無敵時間**: 被弾後2秒間の無敵時間
- **ゲームオーバー**: ハート0でゲームオーバー画面表示
- **UI表示**: 画面上部中央にハート表示、親敵HP（親敵数分）

### ステージシステム
- **ステージ進行**: 親敵全滅でステージクリア
- **ステージ数**: 最大10ステージ
- **親敵数増加**: ステージ1は1体、以後+1体（最大5体）
- **クリア演出**: ステージクリア画面、プログレスバー表示
- **ゲーム完了**: 全ステージクリアでゲーム完了画面

**詳細な実装計画**: `PLAN.md` を参照  
**完了済み履歴**: `HISTORY.md` を参照

## 動作環境
- **ブラウザ**: モダンブラウザ（Chrome, Firefox, Safari, Edge）
- **技術要件**: WebGL対応必須
- **プラットフォーム**: PC・スマートフォン・タブレット対応
- **ホスティング**: GitHub Pages での静的ホスティング
- **パフォーマンス**: 高フレームレート目標、軽量設計